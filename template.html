<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script
        src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"
    ></script>
    <script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
        integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
        crossorigin="anonymous"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link id="theme-link" rel="stylesheet" href="style.css">
    <!-- Google API script removed as it's not needed for OAuth -->
    <!-- script.js functionality is included inline in this file -->
    <title>Photo Booth Template</title>
    <style>
        /* Dark mode body styling */
        body {
            background: #1a1a1a;
            color: #f0f0f0;
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, sans-serif;
        }

        #backButton {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(50, 50, 50, 0.9);
            backdrop-filter: blur(10px);
            color: #f0f0f0;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 22px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        #backButton:hover {
            background: rgba(70, 70, 70, 1);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }

        #backButton:active {
            transform: translateY(0);
        }

        .icon {
            width: 20px;
            height: 20px;
        }

        .container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding-left: 50px;
            width: 80%;
        }
        

        .template-selection {
            display: flex;
            height: 100%;
            flex-direction: column;
            align-items: flex-start;
            gap: 25px;
            padding-left: 40px;
        }

        .template-header {
            margin-bottom: 5px;
            text-align: center;
        }

        .template-selection h1 {
            margin: 0 0 8px 0;
            font-size: 24px;
            font-weight: 700;
            color: #f0f0f0;
            letter-spacing: -0.02em;
        }

        .temp-subtitle {
            font-size: 14px;
            color: #b0b0b0;
            margin: 0;
            font-weight: 400;
        }

        .template-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            max-width: 400px;
        }

        .template-btn {
            width: 80px;
            height: 90px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            background: rgba(50, 50, 50, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .template-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, transparent 0%, rgba(102, 126, 234, 0.2) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .template-btn:hover::before {
            opacity: 1;
        }

        .template-preview {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .template-name {
            font-size: 11px;
            font-weight: 600;
            color: #f0f0f0;
            text-align: center;
            transition: color 0.3s ease;
        }

        .template-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.25);
            border-color: #667eea;
        }

        .template-btn:hover .template-preview {
            transform: scale(1.1);
        }

        .template-btn:hover .template-name {
            color: #667eea;
        }

        .template-btn.active-template {
            border: 4px solid #eff2ff;
            background: rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3), 0 0 30px rgba(102, 126, 234, 0.4);
        }

        .template-btn.active-template .template-name {
            color: #667eea;
        }

        .template-btn.active-template:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.35), 0 0 40px rgba(102, 126, 234, 0.5);
        }



        /* Template specific colors for preview */
        #btn-template7 .template-preview { 
            background: linear-gradient(135deg, #5078f2 0%, #764ba2 100%);
        }
        #btn-template2 .template-preview { 
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
        }
        #btn-template3 .template-preview { 
            background: linear-gradient(135deg, #c8b6b3 0%, #a0807a 100%);
        }
        #btn-template4 .template-preview { 
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }
        #btn-template5 .template-preview { 
            background: linear-gradient(135deg, #fbffd4 0%, #f4f3a0 100%);
        }
        #btn-template3 { background: #c8b6b3; }
        #btn-template4 { background: #ff0000; }
        #btn-template5 { background: #fbffd4; }
        #btn-template7 { background:rgb(80, 122, 229); }

        .template-container {
            position: relative;
            width: 315px;
            height: 560px;
            overflow: hidden;
            background: transparent;
            filter: drop-shadow(5px 5px 15px rgba(0, 0, 0, 0.223)); /* Soft shadow */
            margin-bottom: 0; /* Space between template and buttons */
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1), 0 0 30px rgba(255, 255, 255, 0.05);
        }

        .button-container {
            display: flex;
            flex-direction: row; /* Arrange buttons in a row */
            justify-content: center; /* Center the buttons */
            gap: 10px; /* Add spacing between buttons */
            margin-top: 5px; /* Add some spacing from the template */
        }
        .photo-slot {
            position: absolute;
            width: 263px;
            height: 150px;
            left: 50%;
            transform: translateX(-50%);
            background-size: cover;
            background-position: center;
            cursor: grab;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            transition: all 0.3s ease;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        /* Hide dashed border when photo is loaded */
        .photo-slot.has-photo {
            border: 2px solid transparent;
        }

        .photo-slot:hover {
            border-color: rgba(102, 126, 234, 0.5);
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);
        }

        .photo-slot.has-photo:hover {
            border-color: rgba(102, 126, 234, 0.7);
        }

        .photo-slot.dragging {
            cursor: grabbing;
            transform: translateX(-50%) scale(1.05);
            z-index: 1000;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .photo-slot.drag-over {
            border-color: #667eea;
            background-color: rgba(102, 126, 234, 0.1);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.4);
        }
        .slot1 { top: 26px; }
        .slot2 { top: 191px; }
        .slot3 { top: 352px; }

        .template {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('TechCon_Template.png') no-repeat center/contain;
            pointer-events: none;
            z-index: 1;
          
        }

     

        .btn-download {
            background: linear-gradient(45deg, #1a237e, #3f51b5, #2196f3, #00bcd4, #2196f3, #3f51b5, #1a237e);
            background-size: 400% 400%;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 4px 16px 0 rgba(26, 35, 126, 0.3), 0 0 20px rgba(59, 130, 246, 0.3);
            animation: gradientShift 4s ease-in-out infinite;
            position: relative;
            overflow: hidden;
            min-width: 120px;
        }

        .btn-download::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn-download:hover::before {
            left: 100%;
        }

        .btn-download:hover {
            transform: translateY(-3px);
            color: whitesmoke;
            box-shadow: 0 10px 30px 0 rgba(26, 35, 126, 0.5), 0 0 30px rgba(59, 130, 246, 0.5);
            animation-duration: 2s;
        }

        .btn-download:active {
            transform: translateY(-1px);
            transition: transform 0.1s;
        }

        .btn-download .btn-icon {
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }


        .btn-again{
            padding: 11px 20px;
            border: none;
            background: #606460;
            color: white;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 40px;
            transition: all 0.3s ease;
        }
        .btn-again:hover{
            color: white;
            background: #4d4d4d;
        }

        .modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .modal.show {
        display: flex;
        opacity: 1;
    }

    .modal-content {
        background: rgba(30, 30, 30, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 10px;
        border-radius: 20px;
        text-align: center;
        max-width: 480px;
        width: 90%;
        box-shadow: 
            0 20px 25px -5px rgba(0, 0, 0, 0.3),
            0 10px 10px -5px rgba(0, 0, 0, 0.2),
            0 0 0 1px rgba(255, 255, 255, 0.1);
        transform: scale(0.8) translateY(40px);
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .modal.show .modal-content {
        transform: scale(1) translateY(0);
    }

    .modal-header {
        margin-bottom: 24px;
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 16px;
        border-bottom: #454545 solid 2px;
    }

    .success-icon {
        margin: 0;
        width: 48px;
        height: 48px;
        animation: successPulse 0.6s ease-out;
        flex-shrink: 0;
    }

    .modal-text-container {
        display: flex;
        flex-direction: column;
        text-align: left;
        flex: 1;
    }

    .modal-content h2 {
        font-size: 20px;
        font-weight: 600;
        color: #f0f0f0;
        margin: 0 0 4px 0;
        letter-spacing: -0.02em;
        line-height: 1.3;
    }

    .modal-subtitle {
        font-size: 14px;
        color: #b0b0b0;
        margin: 0 0 8px 0;
        font-weight: 400;
        line-height: 1.4;
    }

    #qrCodeContainer {
        display: none; /* Initially hidden */
        justify-content: center;
        align-items: center;
        margin: 24px auto;
        padding: 16px; /* 8px + QR code size padding */
        border-radius: 12px;
        background: white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        width: fit-content;
        height: fit-content;
    }

    /* Show QR container when modal is visible */
    .modal.show #qrCodeContainer {
        display: flex;
    }

    .modal-footer {
        border-top: #454545 solid 2px;
        margin-top: 24px;
        justify-content: center;
    }

    .made-by {
        font-size: 12px;
        color: #b0b0b0;
        margin: 0 0 20px 0;
        font-weight: 400;
        text-align: center;
    }

    .download-btn {
        background: linear-gradient(45deg, #1a237e, #3f51b5, #2196f3, #00bcd4, #2196f3, #3f51b5, #1a237e);
        background-size: 400% 400%;
        color: white;
        border: none;
        padding: 14px 28px;
        border-radius: 14px;
        cursor: pointer;
        font-size: 15px;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        width: 100%;
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        box-shadow: 0 6px 20px 0 rgba(26, 35, 126, 0.35), 0 0 25px rgba(59, 130, 246, 0.3);
        animation: gradientShift 4s ease-in-out infinite;
        position: relative;
        overflow: hidden;
    }

    .download-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }

    .download-btn:hover::before {
        left: 100%;
    }

    .download-btn:hover {
        transform: translateY(-3px);
        color: whitesmoke;
        box-shadow: 0 12px 28px 0 rgba(26, 35, 126, 0.5), 0 0 35px rgba(59, 130, 246, 0.5);
        animation-duration: 2s;
    }

    .download-btn:active {
        transform: translateY(-1px);
        transition: transform 0.1s;
    }

    .btn-text {
        font-weight: 600;
        letter-spacing: 0.02em;
    }

    .btn-icon {
        transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }


    @keyframes gradientShift {
        0%, 100% {
            background-position: 0% 50%;
        }
        50% {
            background-position: 100% 50%;
        }
    }

    @keyframes successPulse {
        0% {
            transform: scale(0.8);
            opacity: 0;
        }
        50% {
            transform: scale(1.1);
        }
        100% {
            transform: scale(1);
            opacity: 1;
        }
    }

    body.modal-open {
        overflow: hidden;
    }

    body.modal-open > *:not(.modal) {
        filter: brightness(0.7);
        transition: filter 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    body:not(.modal-open) > * {
        filter: none;
        transition: filter 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .close-btn {
        background: #e11f1f;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        width: 100%;
        margin-top: 15px;
        animation: blink 2s infinite;
    }

    @keyframes blink {
    0% {
        opacity: 1;
    }
    50% {
        opacity: 0;
    }
    100% {
        opacity: 1;
    }
    }



    .close-btn:hover {
        background: #0056b3;
    }

    .hidden {
        display: none;
    }

    /* Material 3 Modal Animations */

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.9);
        }
        to {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
    }

    .settings-button {
        animation: buttonFadeIn 0.2s cubic-bezier(0.2, 0, 0, 1);
    }

    @keyframes buttonFadeIn {
        from {
            opacity: 0;
            transform: translateY(8px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Ripple Effect */
    .settings-button {
        position: relative;
        overflow: hidden;
    }

    .settings-button::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: translate(-50%, -50%);
        transition: width 0.3s, height 0.3s;
    }

    .settings-button:active::after {
        width: 300px;
        height: 300px;
    }

#settingsPanel {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(8px);
    z-index: 5000;
    animation: fadeIn 0.3s ease;
}

#settingsPanel.show {
    display: flex;
    align-items: center;
    justify-content: center;
}

.settings-modal-content {
    background: rgba(30, 30, 30, 0.95);
    backdrop-filter: blur(30px) saturate(180%);
    -webkit-backdrop-filter: blur(30px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 24px;
    padding: 0;
    box-shadow: 
        0 20px 25px -5px rgba(0, 0, 0, 0.3),
        0 10px 10px -5px rgba(0, 0, 0, 0.2),
        0 0 0 1px rgba(255, 255, 255, 0.1);
    width: 90%;
    max-width: 480px;
    animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    overflow: hidden;
}

.settings-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 25px 30px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(50, 50, 50, 0.2);
}

.settings-modal-header h2 {
    font-size: 24px;
    font-weight: 700;
    color: #f0f0f0;
    margin: 0;
}

.settings-close {
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: #b0b0b0;
    padding: 0;
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
}

.settings-close:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #f0f0f0;
    transform: rotate(90deg);
}

.settings-modal-body {
    padding: 30px;
    max-height: 60vh;
    overflow-y: auto;
}

.settings-section {
    margin-bottom: 35px;
}

.settings-section:last-child {
    margin-bottom: 0;
}

.settings-section h3 {
    font-size: 18px;
    font-weight: 600;
    color: #f0f0f0;
    margin: 0 0 8px 0;
}

.settings-description {
    font-size: 14px;
    color: #b0b0b0;
    margin: 0 0 20px 0;
}

.settings-option {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.settings-option:last-child {
    border-bottom: none;
    padding-bottom: 0;
}

.settings-option-info {
    flex: 1;
}

.settings-label {
    font-size: 16px;
    font-weight: 500;
    color: #f0f0f0;
    margin: 0 0 4px 0;
    display: block;
}

.settings-sublabel {
    font-size: 13px;
    color: #b0b0b0;
    display: block;
    line-height: 1.4;
}

.settings-modal-footer {
    display: flex;
    gap: 15px;
    padding: 25px 30px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(50, 50, 50, 0.2);
}

.settings-btn {
    flex: 1;
    padding: 14px 24px;
    border: none;
    border-radius: 12px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    position: relative;
    overflow: hidden;
}

.settings-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    transition: left 0.5s;
}

.settings-btn:hover::before {
    left: 100%;
}

.settings-btn-secondary {
    background: rgba(107, 114, 128, 0.1);
    color: #6b7280;
    border: 1px solid rgba(107, 114, 128, 0.2);
}

.settings-btn-secondary:hover {
    background: rgba(107, 114, 128, 0.15);
    color: #4b5563;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.settings-btn-primary {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    box-shadow: 0 4px 14px 0 rgba(16, 185, 129, 0.3);
}

.settings-btn-primary:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px 0 rgba(16, 185, 129, 0.4);
}

#googleSignIn {
    flex: none;
    min-width: 80px;
    max-width: 120px;
    padding: 10px 16px;
    font-size: 13px;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from { 
        opacity: 0;
        transform: translateY(20px);
    }
    to { 
        opacity: 1;
        transform: translateY(0);
    }
}

    #settingsButton {
        position: fixed;
        top: 20px;
        right: 20px;
        background:transparent;
        backdrop-filter: blur(10px);
        color: #f0f0f0;
        border: none;
        padding: 8px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        box-shadow: 0px 2px 8px rgba(0, 0, 0, 0.3);
        transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
        width: 52px;
        height: 52px;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
    }

    #settingsButton:hover {
        box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.4);
        transform: translateY(-1px);
        background: rgba(70, 70, 70, 1);
    }

    #settingsButton:active {
        transform: translateY(0);
    }

    .icon {
        width: 20px;
        height: 20px;
    }

    .logo-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        object-fit: contain;
        filter: drop-shadow(0px 2px 4px rgba(0, 0, 0, 0.2));
    }

    /* Old account modal styles removed - now using Settings modal design */

    #progressDialog {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        z-index: 1000000;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        pointer-events: none;
    }

    #progressDialog.show {
        opacity: 1;
        pointer-events: all;
    }

    .progress-content {
        background: rgba(30, 30, 30, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 35px;
        border-radius: 24px;
        text-align: center;
        max-width: 380px;
        width: 90%;
        box-shadow: 
            0 20px 25px -5px rgba(0, 0, 0, 0.3),
            0 10px 10px -5px rgba(0, 0, 0, 0.2),
            0 0 0 1px rgba(255, 255, 255, 0.1),
            0 0 30px rgba(0, 255, 215, 0.15),
            0 0 60px rgba(102, 126, 234, 0.1);
        transform: scale(0.9) translateY(20px);
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        animation: subtleGlow 4s ease-in-out infinite;
    }

    #progressDialog.show .progress-content {
        transform: scale(1) translateY(0);
    }

    .progress-icon {
        margin: 0 auto 20px;
        width: 48px;
        height: 48px;
        animation: spin 2s linear infinite;
    }

    .progress-title {
        font-size: 18px;
        font-weight: 600;
        color: #f0f0f0;
        margin: 0 0 8px 0;
        letter-spacing: -0.02em;
        opacity: 0;
        transform: translateY(10px);
        animation: textSlideIn 0.6s ease-out 0.2s forwards;
    }

    .progress-message {
        font-size: 13px;
        color: #b0b0b0;
        margin: 0 0 24px 0;
        font-weight: 400;
        opacity: 0;
        transform: translateY(10px);
        animation: textSlideIn 0.6s ease-out 0.4s forwards;
        min-height: 18px;
        transition: opacity 0.3s ease, transform 0.3s ease;
    }

    #progressBarContainer {
        width: 100%;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        overflow: hidden;
        height: 8px;
        position: relative;
        margin-bottom: 16px;
        opacity: 0;
        transform: translateY(10px);
        animation: textSlideIn 0.6s ease-out 0.6s forwards;
    }

    #progressBar {
        width: 0%;
        height: 100%;
        background: linear-gradient(45deg, #00ffd7, #00e6f5, #00c8ff, #00a5ff, #007aff, #8f63ed, #c842cd, #eb00a1, #ff3175, #ff7546, #ffb408, #ffed00, #00ffd7, #00e6f5, #00c8ff);
        background-size: 400% 400%;
        border-radius: 12px;
        transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        box-shadow: 0 0 20px rgba(0, 255, 215, 0.5), 0 0 40px rgba(0, 255, 215, 0.3), 0 0 60px rgba(255, 237, 0, 0.2);
        animation: gradientFlow 3s ease-in-out infinite, pulseGlow 2s ease-in-out infinite;
    }

    #progressBar::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        animation: shimmer 2s infinite;
    }

    .progress-percentage {
        font-size: 12px;
        color: #b0b0b0;
        font-weight: 500;
        margin: 0;
        opacity: 0;
        transform: translateY(10px);
        animation: textSlideIn 0.6s ease-out 0.8s forwards;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    @keyframes shimmer {
        0% { left: -100%; }
        100% { left: 100%; }
    }

    @keyframes gradientFlow {
        0%, 100% {
            background-position: 0% 50%;
        }
        50% {
            background-position: 100% 50%;
        }
    }

    @keyframes pulseGlow {
        0%, 100% {
            box-shadow: 0 0 20px rgba(0, 255, 215, 0.3), 0 0 40px rgba(0, 255, 215, 0.2), 0 0 60px rgba(255, 237, 0, 0.1);
        }
        50% {
            box-shadow: 0 0 30px rgba(0, 255, 215, 0.6), 0 0 60px rgba(0, 255, 215, 0.4), 0 0 90px rgba(255, 237, 0, 0.3);
        }
    }

    @keyframes subtleGlow {
        0%, 100% {
            box-shadow: 
                0 20px 25px -5px rgba(0, 0, 0, 0.3),
                0 10px 10px -5px rgba(0, 0, 0, 0.2),
                0 0 0 1px rgba(255, 255, 255, 0.1),
                0 0 20px rgba(0, 255, 215, 0.1),
                0 0 40px rgba(102, 126, 234, 0.05);
        }
        50% {
            box-shadow: 
                0 20px 25px -5px rgba(0, 0, 0, 0.3),
                0 10px 10px -5px rgba(0, 0, 0, 0.2),
                0 0 0 1px rgba(255, 255, 255, 0.1),
                0 0 40px rgba(0, 255, 215, 0.2),
                0 0 80px rgba(102, 126, 234, 0.15);
        }
    }

    @keyframes templateFadeIn {
        0% {
            opacity: 0;
            transform: scale(0.95);
        }
        100% {
            opacity: 1;
            transform: scale(1);
        }
    }

    .template-loading {
        animation: templateFadeIn 0.8s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes textSlideIn {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Prevent interaction with background */
    body.progress-loading {
        overflow: hidden;
    }

    body.progress-loading > *:not(#progressDialog) {
        pointer-events: none;
        transition: filter 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    body:not(.progress-loading) > * {
        pointer-events: auto;
        filter: none;
        transition: filter 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    /* Drag instruction styling */
    .drag-instruction {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-top: 15px;
        padding: 8px 16px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        color: #b0b0b0;
        font-size: 13px;
        font-weight: 400;
        opacity: 0;
        transform: translateY(10px);
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        backdrop-filter: blur(10px);
        width: fit-content;
        margin-left: auto;
        margin-right: auto;
        pointer-events: none;
    }

    .drag-instruction.show {
        opacity: 1;
        transform: translateY(0);
    }

    .drag-instruction svg {
        opacity: 0.7;
        transition: opacity 0.2s ease;
    }

    .drag-instruction.show svg {
        opacity: 1;
    }

    /* Enhanced drag states */
    .photo-slot.dragging {
        opacity: 0.9;
        transform: translateX(-50%) scale(1.1);
        box-shadow: 0 12px 35px rgba(0, 0, 0, 0.4);
        z-index: 1000;
        transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        animation: popOutCentered 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .photo-slot.drag-over {
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3);
        transform: translateX(-50%) scale(1.05);
        transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        animation: popInCentered 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes popOutCentered {
        0% {
            transform: translateX(-50%) scale(1);
            opacity: 1;
        }
        50% {
            transform: translateX(-50%) scale(1.15);
            opacity: 0.8;
        }
        100% {
            transform: translateX(-50%) scale(1.1);
            opacity: 0.9;
        }
    }

    @keyframes popInCentered {
        0% {
            transform: translateX(-50%) scale(1);
        }
        50% {
            transform: translateX(-50%) scale(1.08);
        }
        100% {
            transform: translateX(-50%) scale(1.05);
        }
    }

    
    </style>
</head>
<body>
        <!-- ‚úÖ QR Code Modal -->
    <div id="qrModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="success-icon">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" fill="#34D399"/>
                        <path d="M9 12L11 14L15 10" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <div class="modal-text-container">
                    <h2>Your soft copy is ready!</h2>
                    <p class="modal-subtitle">Scan the QR code below to download your photo</p>
                </div>
            </div>
            <div id="qrCodeContainer"></div>
            <div class="modal-footer">
                <p class="made-by">Made by the Society of Computer Engineering Students</p>
                <button class="download-btn" onclick="goToFormatSelection()">
                    <span class="btn-text">Done</span>
                    <svg class="btn-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 5L19 12L12 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </button>
            </div>
        </div>
    </div>
        <!-- Progress Dialog -->
    <div id="progressDialog">
        <div class="progress-content">
            <div class="progress-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2V6M12 18V22M4.93 4.93L7.76 7.76M16.24 16.24L19.07 19.07M2 12H6M18 12H22M4.93 19.07L7.76 16.24M16.24 7.76L19.07 4.93" stroke="#667eea" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </div>
            <h3 class="progress-title">Preparing your QR Code</h3>
            <p class="progress-message">Please wait while we process your photo...</p>
            <div id="progressBarContainer">
                <div id="progressBar"></div>
            </div>
            <p class="progress-percentage">0%</p>
        </div>
    </div>


    <!-- Back Button -->
    <button id="backButton" onclick="goBack()">‚Üê</button>
    
    <button id="settingsButton">
        <img src="logo.png" alt="SCpES Logo" class="logo-icon">
    </button>


    <div class="background-container">
        <img src="bg.png" class="bg" alt="Background Image">
        <div class="elipse"></div>
        <svg class="border bottom-left" fill="currentColor">
            <use xlink:href="icons.svg#wave-1"></use>
        </svg>
        <svg class="border upper-right" fill="currentColor">
            <use xlink:href="icons.svg#wave-2"></use>
        </svg>
    </div>

    <div class="container">
        <div>
            <div class="template-container" id="photo-booth">
                <div class="photo-slot slot1" id="photo1" draggable="true"></div>
                <div class="photo-slot slot2" id="photo2" draggable="true"></div>
                <div class="photo-slot slot3" id="photo3" draggable="true"></div>
                <div class="template" id="template-image"></div>
            </div>
            
            <!-- Subtle instruction prompt -->
            <div class="drag-instruction" id="dragInstruction" style="display: none;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M7 7h10v10H7V7z" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M14 11l-3 3-3-3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Drag photos to rearrange order</span>
            </div>
    
       
        </div>
    
        <div class="template-selection">
            <div class="template-header">
                <h1 class="temp-title">Choose Your Style ‚ú®</h1>
                <p class="temp-subtitle">Pick a template that matches your vibe</p>
            </div>
            <div class="template-buttons">
                <button class="template-btn" onclick="changeTemplate('TechCon_Template.png');" id="btn-template7" data-template="TechCon_Template.png">
                    <div class="template-preview"></div>
                    <span class="template-name">Tech</span>
                </button>
                <!-- <button class="template-btn" onclick="changeTemplate('template4.png'); setTimeout(() => loadPhotos(), 0);" id="btn-template4"></button>
                <button class="template-btn" onclick="changeTemplate('template2.png'); setTimeout(() => loadPhotos(), 0);" id="btn-template2"></button>
                <button class="template-btn" onclick="changeTemplate('template3.png'); setTimeout(() => loadPhotos(), 0);" id="btn-template3"></button>
                <button class="template-btn" onclick="changeTemplate('template4.png'); setTimeout(() => loadPhotos(), 0);" id="btn-template4"></button>
                <button class="template-btn" onclick="changeTemplate('template5.png'); setTimeout(() => loadPhotos(), 0);" id="btn-template5"></button> -->
            </div>
            <div class="button-container">
                <button class="btn btn-download" onclick="downloadImage()">
                    <span class="btn-text">Download</span>
                    <svg class="btn-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 15V19A2 2 0 0 1 19 21H5A2 2 0 0 1 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <polyline points="7,10 12,15 17,10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="12" y1="15" x2="12" y2="3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
                <div id="qrCodeContainer" class="mt-3"></div>
                <!-- ‚úÖ Account Modal (Hidden by Default) -->
                <div id="settingsPanel" class="settings-modal">
                    <div class="settings-modal-content">
                        <div class="settings-modal-header">
                            <h2>Account</h2>
                            <button class="settings-close" onclick="closeAccountModal()">&times;</button>
                        </div>
                        <div class="settings-modal-body">
                            <div class="settings-section">
                                <h3>Google Account</h3>
                                <p class="settings-description">Manage your Google account connection</p>
                                
                                <div class="settings-option">
                                    <div class="settings-option-info">
                                        <label class="settings-label" id="userInfo">Please sign in to upload to Google Drive</label>
                                        <span class="settings-sublabel">Connect your Google account to upload photos</span>
                                    </div>
                                </div>
                                
                                <div class="settings-option" id="signInOption">
                                    <div class="settings-option-info">
                                        <label class="settings-label">Sign in with Google</label>
                                        <span class="settings-sublabel">Connect your Google account</span>
                                    </div>
                                    <button id="googleSignIn" class="settings-btn settings-btn-primary">Sign In</button>
                                </div>
                                
                                <div class="settings-option" id="logoutOption" style="display: none;">
                                    <div class="settings-option-info">
                                        <label class="settings-label">Logout</label>
                                        <span class="settings-sublabel">Disconnect your Google account</span>
                                    </div>
                                    <button id="logoutButton" class="settings-btn settings-btn-secondary">Logout</button>
                                </div>
                            </div>
                        </div>
                        <div class="settings-modal-footer">
                            <button class="settings-btn settings-btn-secondary" onclick="closeAccountModal()">Cancel</button>
                            <button class="settings-btn settings-btn-primary" onclick="closeAccountModal()">Done</button>
                        </div>
                    </div>
                </div>

   

                <!-- ‚úÖ QR Code Modal -->
                <div id="qrModal" class="modal">
                    <div class="modal-content">
                        <span class="close-btn" onclick="closeQRModal()">&times;</span>
                        <h2>Scan to Access Image</h2>
                        <div id="qrCodeContainer"></div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const themeLink = document.getElementById("theme-link");
            const savedTheme = localStorage.getItem("theme");
    
            if (savedTheme === "dark") {
                themeLink.setAttribute("href", "dark-style.css");
            } else {
                themeLink.setAttribute("href", "style.css");
            }

            const settingsButton = document.getElementById("settingsButton");
            const settingsPanel = document.getElementById("settingsPanel");
            const closeSettings = document.getElementById("closeSettings");

            // Open Settings Panel
            settingsButton.addEventListener("click", function () {
                settingsPanel.classList.remove("hidden");
            });

            // Close Settings Panel
            closeSettings.addEventListener("click", function () {
                settingsPanel.classList.add("hidden");
            });

            
            // Check if user is logged in first
            checkLoginStatus();
            
            // Also check template-specific login status for UI updates
            checkTemplateLoginStatus();


            // Manual Logout Button - Attach event listener
            const logoutButton = document.getElementById("logoutButton");
            if (logoutButton) {
                console.log("‚úÖ Logout button found, attaching event listener");
                logoutButton.setAttribute('data-listener-attached', 'true');
                logoutButton.addEventListener("click", function (event) {
                    event.preventDefault();
                    console.log("üñ±Ô∏è Logout button clicked");
                    logout();
                });
            } else {
                console.error("‚ùå Logout button not found!");
            }

            // Auto Logout if Script Fails
            setTimeout(function () {
                if (document.readyState !== "complete") {
                    alert("System encountered an issue. Logging out...");
                    logout();
                }
            }, 5000); // Checks after 5 seconds
               

        
        
        }

                
            
            );
    </script>
    
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="shared-login.js"></script>
    <script>
        let accessToken = localStorage.getItem("googleAccessToken") || "";
        const selectedFormat = localStorage.getItem("selectedFormat") || "new";
        
        // ‚úÖ Global Logout Function
        async function logout() {
            console.log("üö™ Logging out...");
            
            try {
                // Revoke the Google OAuth token if it exists
                if (accessToken && accessToken.length > 0) {
                    console.log("üîÑ Revoking Google OAuth token...");
                    await revokeGoogleToken(accessToken);
                }
            } catch (error) {
                console.error("‚ùå Error revoking token:", error);
                // Continue with logout even if token revocation fails
            }
            
            // Clear local storage
            accessToken = "";
            localStorage.removeItem("googleAccessToken");
            localStorage.removeItem("userLoggedIn");
            
            // Update modal status
            updateModalLoginStatus();
            
            alert("Logged out successfully!");
        }
        
        // ‚úÖ Revoke Google OAuth Token
        async function revokeGoogleToken(token) {
            try {
                const response = await fetch(`https://oauth2.googleapis.com/revoke?token=${token}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                });
                
                if (response.ok) {
                    console.log("‚úÖ Google OAuth token revoked successfully");
                } else {
                    console.error("‚ùå Failed to revoke token:", response.status, response.statusText);
                }
            } catch (error) {
                console.error("‚ùå Error revoking token:", error);
                throw error;
            }
        }
        
        // Function to refresh access token from localStorage
        function refreshAccessToken() {
            const newToken = localStorage.getItem("googleAccessToken") || "";
            if (newToken !== accessToken) {
                console.log("üîÑ Access token updated from localStorage");
                accessToken = newToken;
            }
            return accessToken;
        }
        
        // Update modal login status when modal is opened
        function updateModalLoginStatus() {
            console.log("üîç Updating modal login status...");
            
            // Refresh token from localStorage
            refreshAccessToken();
            
            const userInfo = document.getElementById("userInfo");
            const signInOption = document.getElementById("signInOption");
            const logoutOption = document.getElementById("logoutOption");
            
            if (accessToken && accessToken.length > 0) {
                console.log("üîç Token found in modal, user should be signed in");
                if (userInfo) {
                    userInfo.innerText = "‚úÖ Signed in and ready to upload!";
                }
                if (signInOption) {
                    signInOption.style.display = "none";
                }
                if (logoutOption) {
                    logoutOption.style.display = "flex";
                }
            } else {
                console.log("üîç No token found in modal, user needs to sign in");
                if (userInfo) {
                    userInfo.innerText = "Please sign in to upload to Google Drive";
                }
                if (signInOption) {
                    signInOption.style.display = "flex";
                }
                if (logoutOption) {
                    logoutOption.style.display = "none";
                }
            }
        }
        
        // Helper function to get correct template path
        function getTemplatePath(templateName) {
            if (selectedFormat === "old") {
                return `classic_templates/${templateName}`;
            } else {
                return `stories_template/${templateName}`;
            }
        }
        
        // Get default template based on format
        function getDefaultTemplate() {
            return selectedFormat === "old" ? "template1.png" : "TechCon_Template.png";
        }
        
        let currentTemplate = localStorage.getItem("selectedTemplate") || getDefaultTemplate();
    
        // ‚úÖ Show/Hide Account Modal
        document.getElementById("settingsButton").addEventListener("click", function () {
            const settingsPanel = document.getElementById("settingsPanel");
            settingsPanel.classList.add("show");
            document.body.style.overflow = 'hidden';
            
            console.log("üîç Account modal opened, checking login status...");
            updateModalLoginStatus();
        });
    
        function closeAccountModal() {
            const settingsPanel = document.getElementById("settingsPanel");
            settingsPanel.classList.remove("show");
            document.body.style.overflow = '';
        }

        // Close modal when clicking outside
        document.getElementById("settingsPanel").addEventListener("click", function(event) {
            if (event.target === this) {
                closeAccountModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const settingsPanel = document.getElementById("settingsPanel");
                if (settingsPanel.classList.contains('show')) {
                    closeAccountModal();
                }
            }
        });
    
        // ‚úÖ Google OAuth Login
        function signInWithGoogle() {
            const client = google.accounts.oauth2.initTokenClient({
                client_id: "1050323234175-b5apn028urg40cqvmavnefprcfbfbqp6.apps.googleusercontent.com",
                scope: "https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive",
                callback: (response) => {
                    if (response.access_token) {
                        accessToken = response.access_token;
                        localStorage.setItem("googleAccessToken", accessToken);
                        document.getElementById("userInfo").innerText = "‚úÖ Signed in!";
                        
                        const signInOption = document.getElementById("signInOption");
                        const logoutOption = document.getElementById("logoutOption");
                        if (signInOption) {
                            signInOption.style.display = "none";
                        }
                        if (logoutOption) {
                            logoutOption.style.display = "flex";
                        }
                        
                        console.log("‚úÖ OAuth Token:", accessToken);
                        
                        // Validate token immediately after login
                        validateGoogleToken(accessToken).then(isValid => {
                            if (isValid) {
                                console.log("‚úÖ Token validated successfully after login");
                                // Update modal status if it's open
                                updateModalLoginStatus();
                            } else {
                                console.error("‚ùå Token validation failed after login");
                            }
                        });
                    } else {
                        console.error("‚ùå Login failed!");
                    }
                },
            });
            client.requestAccessToken();
        }
    
        // ‚úÖ Hide sign-in button if already logged in
        function checkTemplateLoginStatus() {
            console.log("üîç Checking template-specific login status...");
            
            // Refresh token from localStorage first
            refreshAccessToken();
            
            console.log("üîç Access token exists:", !!accessToken);
            console.log("üîç Access token value:", accessToken ? accessToken.substring(0, 20) + "..." : "none");
            
            if (accessToken && accessToken.length > 0) {
                // Verify token is still valid
                console.log("üîç Token found, verifying...");
                verifyToken();
            } else {
                console.log("üîç No token found, showing sign-in button");
                // Make sure elements exist before trying to update them
                const userInfo = document.getElementById("userInfo");
                const signInOption = document.getElementById("signInOption");
                const logoutOption = document.getElementById("logoutOption");
                
                if (userInfo) {
                    userInfo.innerText = "Please sign in to upload to Google Drive";
                }
                if (signInOption) {
                    signInOption.style.display = "flex";
                }
                if (logoutOption) {
                    logoutOption.style.display = "none";
                }
            }
        }
        
        // ‚úÖ Verify if the current token is still valid
        async function verifyToken() {
            try {
                console.log("üîç Verifying token with Google...");
                const response = await fetch(`https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=${accessToken}`);
                console.log("üîç Token verification response status:", response.status);
                
                if (response.ok) {
                    const tokenInfo = await response.json();
                    console.log("‚úÖ Token is valid:", tokenInfo);
                    
                    const signInOption = document.getElementById("signInOption");
                    const logoutOption = document.getElementById("logoutOption");
                    const userInfo = document.getElementById("userInfo");
                    
                    if (signInOption) {
                        signInOption.style.display = "none";
                    }
                    if (logoutOption) {
                        logoutOption.style.display = "flex";
                    }
                    if (userInfo) {
                        userInfo.innerText = "‚úÖ Signed in and ready to upload!";
                    }
                } else {
                    // Token expired or invalid
                    console.log("‚ùå Token expired or invalid, clearing stored token");
                    accessToken = "";
                    localStorage.removeItem("googleAccessToken");
                    
                    const userInfo = document.getElementById("userInfo");
                    const signInOption = document.getElementById("signInOption");
                    const logoutOption = document.getElementById("logoutOption");
                    
                    if (userInfo) {
                        userInfo.innerText = "Session expired. Please sign in again.";
                    }
                    if (signInOption) {
                        signInOption.style.display = "flex";
                    }
                    if (logoutOption) {
                        logoutOption.style.display = "none";
                    }
                }
            } catch (error) {
                console.error("‚ùå Error verifying token:", error);
                accessToken = "";
                localStorage.removeItem("googleAccessToken");
                
                const userInfo = document.getElementById("userInfo");
                const signInOption = document.getElementById("signInOption");
                const logoutOption = document.getElementById("logoutOption");
                
                if (userInfo) {
                    userInfo.innerText = "Please sign in to upload to Google Drive";
                }
                if (signInOption) {
                    signInOption.style.display = "flex";
                }
                if (logoutOption) {
                    logoutOption.style.display = "none";
                }
            }
        }
    
        // ‚úÖ Load Photos (Fix: Ensure they appear correctly)
        function loadPhotos() {
            const images = JSON.parse(localStorage.getItem("capturedPhotos")) || [];
            console.log("Loading photos:", images); // Debug log
            
            if (images.length === 3) {
                // Wait for DOM to be ready, then load photos
                const attemptLoad = () => {
                    const photo1 = document.getElementById("photo1");
                    const photo2 = document.getElementById("photo2");
                    const photo3 = document.getElementById("photo3");
                    
                    console.log("Photo elements found:", photo1, photo2, photo3); // Debug log
                    
                    if (photo1 && photo2 && photo3) {
                        // Only load photos if they don't already have the correct images
                        const currentImages = [
                            photo1.style.backgroundImage,
                            photo2.style.backgroundImage,
                            photo3.style.backgroundImage
                        ];
                        
                        const expectedImages = [
                            `url("${images[0]}")`,
                            `url("${images[1]}")`,
                            `url("${images[2]}")`
                        ];
                        
                        // Check if photos are already loaded correctly
                        const photosAlreadyLoaded = currentImages.every((current, index) => 
                            current === expectedImages[index]
                        );
                        
                        if (!photosAlreadyLoaded) {
                            // Load photos smoothly without clearing first
                            photo1.style.backgroundImage = `url('${images[0]}')`;
                            photo2.style.backgroundImage = `url('${images[1]}')`;
                            photo3.style.backgroundImage = `url('${images[2]}')`;
                            
                            // Add has-photo class to hide dashed borders
                            photo1.classList.add('has-photo');
                            photo2.classList.add('has-photo');
                            photo3.classList.add('has-photo');
                            
                            // Ensure proper background properties for photo display
                            [photo1, photo2, photo3].forEach(element => {
                                element.style.backgroundSize = "cover";
                                element.style.backgroundPosition = "center";
                                element.style.backgroundRepeat = "no-repeat";
                            });
                            
                            // Initialize drag and drop after photos are loaded
                            initializeDragAndDrop();
                            
                            // Show drag instruction
                            showDragInstruction();
                            
                            console.log("Photos loaded successfully"); // Debug log
                        } else {
                            console.log("Photos already loaded correctly, skipping reload"); // Debug log
                        }
                    } else {
                        console.error("Photo elements not found in DOM"); // Debug log
                        // Retry after a short delay if elements not found
                        setTimeout(attemptLoad, 50);
                    }
                };
                
                attemptLoad();
            } else {
                console.warn("Not enough photos found:", images.length); // Debug log
            }
        }
    
        // ‚úÖ Drag and Drop Functionality for Photo Slots
        let draggedElement = null;
        let touchStartY = 0;
        let touchStartX = 0;
        let isDragging = false;
    
        function initializeDragAndDrop() {
            const photoSlots = document.querySelectorAll('.photo-slot');
            
            photoSlots.forEach((slot, index) => {
                // Remove existing event listeners first to prevent duplicates
                slot.removeEventListener('mousedown', handleMouseDown);
                slot.removeEventListener('touchstart', handleTouchStart);
                slot.removeEventListener('dragstart', handleDragStart);
                slot.removeEventListener('dragover', handleDragOver);
                slot.removeEventListener('drop', handleDrop);
                slot.removeEventListener('dragend', handleDragEnd);
                
                // Mouse events
                slot.addEventListener('mousedown', handleMouseDown);
                
                // Touch events for mobile
                slot.addEventListener('touchstart', handleTouchStart, { passive: false });
                
                // Native HTML5 drag and drop for mouse
                slot.draggable = true;
                slot.addEventListener('dragstart', handleDragStart);
                slot.addEventListener('dragover', handleDragOver);
                slot.addEventListener('drop', handleDrop);
                slot.addEventListener('dragend', handleDragEnd);
                
                // Add data attribute for easy identification
                slot.setAttribute('data-slot-index', index);
            });
        }
        
        function handleMouseDown(e) {
            // Allow native drag and drop for mouse, prevent for touch
            if (e.type === 'mousedown') {
                // Don't prevent default for mouse - allow native drag
                return;
            }
            e.preventDefault();
        }
        
        function handleTouchStart(e) {
            if (e.touches.length !== 1) return;
            
            const touch = e.touches[0];
            touchStartX = touch.clientX;
            touchStartY = touch.clientY;
            isDragging = false;
            draggedElement = e.currentTarget;
            
            // Prevent default to avoid scrolling
            e.preventDefault();
            
            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.addEventListener('touchend', handleTouchEnd);
        }
        
        function handleTouchMove(e) {
            if (!draggedElement) return;
            
            const touch = e.touches[0];
            const deltaX = Math.abs(touch.clientX - touchStartX);
            const deltaY = Math.abs(touch.clientY - touchStartY);
            
            // Start dragging if moved enough
            if ((deltaX > 10 || deltaY > 10) && !isDragging) {
                isDragging = true;
                draggedElement.classList.add('dragging');
            }
            
            if (isDragging) {
                e.preventDefault();
                
                // Find element under touch point
                const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                const dropTarget = elementBelow?.closest('.photo-slot');
                
                // Remove drag-over class from all slots
                document.querySelectorAll('.photo-slot').forEach(slot => {
                    slot.classList.remove('drag-over');
                });
                
                // Add drag-over class to valid drop target
                if (dropTarget && dropTarget !== draggedElement) {
                    dropTarget.classList.add('drag-over');
                }
            }
        }
        
        function handleTouchEnd(e) {
            if (isDragging && draggedElement) {
                const touch = e.changedTouches[0];
                const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                const dropTarget = elementBelow?.closest('.photo-slot');
                
                if (dropTarget && dropTarget !== draggedElement) {
                    swapPhotoSlots(draggedElement, dropTarget);
                }
            }
            
            // Clean up
            document.querySelectorAll('.photo-slot').forEach(slot => {
                slot.classList.remove('dragging', 'drag-over');
            });
            
            document.removeEventListener('touchmove', handleTouchMove);
            document.removeEventListener('touchend', handleTouchEnd);
            
            draggedElement = null;
            isDragging = false;
        }
        
        function handleDragStart(e) {
            draggedElement = e.currentTarget;
            e.currentTarget.classList.add('dragging');
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            if (e.currentTarget !== draggedElement) {
                e.currentTarget.classList.add('drag-over');
            }
        }
        
        function handleDrop(e) {
            e.preventDefault();
            if (e.currentTarget !== draggedElement && draggedElement) {
                swapPhotoSlots(draggedElement, e.currentTarget);
            }
        }
        
        function handleDragEnd(e) {
            document.querySelectorAll('.photo-slot').forEach(slot => {
                slot.classList.remove('dragging', 'drag-over');
            });
            draggedElement = null;
        }
        
        function swapPhotoSlots(slot1, slot2) {
            const index1 = parseInt(slot1.getAttribute('data-slot-index'));
            const index2 = parseInt(slot2.getAttribute('data-slot-index'));
            
            // Get current images from localStorage
            const images = JSON.parse(localStorage.getItem("capturedPhotos")) || [];
            
            if (images.length >= 3 && index1 < images.length && index2 < images.length) {
                // Swap the images in the array
                [images[index1], images[index2]] = [images[index2], images[index1]];
                
                // Save back to localStorage
                localStorage.setItem("capturedPhotos", JSON.stringify(images));
                
                // Reload photos to reflect the change
                loadPhotos();
                
                console.log(`Swapped photos at positions ${index1} and ${index2}`);
            }
        }
        
        // Show drag instruction when photos are loaded
        function showDragInstruction() {
            const dragInstruction = document.getElementById("dragInstruction");
            const images = JSON.parse(localStorage.getItem("capturedPhotos")) || [];
            
            if (images.length === 3 && dragInstruction) {
                dragInstruction.style.display = "flex";
                
                // Delay the show animation slightly
                setTimeout(() => {
                    dragInstruction.classList.add("show");
                }, 300);
                
                // Remove auto-hide - let the instruction stay visible
                // User can still interact with it and it provides helpful guidance
            }
        }
        
        // Hide drag instruction
        function hideDragInstruction() {
            const dragInstruction = document.getElementById("dragInstruction");
            if (dragInstruction) {
                dragInstruction.classList.remove("show");
                setTimeout(() => {
                    dragInstruction.style.display = "none";
                }, 300);
            }
        }
    
        // ‚úÖ Change Template
        function changeTemplate(templateSrc) {
            console.log("Template changed to:", templateSrc);
            currentTemplate = templateSrc;
            localStorage.setItem("selectedTemplate", templateSrc);

            const templateContainer = document.getElementById("photo-booth");
            const templateImage = document.getElementById("template-image");
            
            // Preserve current photos during template change
            const currentPhotos = {
                photo1: document.getElementById("photo1").style.backgroundImage,
                photo2: document.getElementById("photo2").style.backgroundImage,
                photo3: document.getElementById("photo3").style.backgroundImage
            };
            
            // Add smooth transition for template only
            templateImage.style.transition = "opacity 0.3s cubic-bezier(0.16, 1, 0.3, 1)";
            templateImage.style.opacity = "0.7";

            // Change template after brief fade
            setTimeout(() => {
                const templatePath = getTemplatePath(templateSrc);
                templateImage.style.backgroundImage = `url('${templatePath}')`;
                
                // Fade template back in
                templateImage.style.opacity = "1";
                
                // Add loading class for subtle animation
                templateContainer.classList.add('template-loading');
                
                // Remove loading class after animation
                setTimeout(() => {
                    templateContainer.classList.remove('template-loading');
                    // Clear transition after animation completes
                    templateImage.style.transition = "";
                }, 800);
                
            }, 150);

            // ‚úÖ Highlight selected template button
            document.querySelectorAll(".template-btn").forEach((btn) => btn.classList.remove("active-template"));
            document.querySelector(`.template-btn[data-template='${templateSrc}']`)?.classList.add("active-template");
        }        // ‚úÖ Load saved template on page refresh
        function loadSelectedTemplate() {
            const selectedFormat = localStorage.getItem("selectedFormat") || "new";
            let savedTemplate = localStorage.getItem("selectedTemplate") || getDefaultTemplate();
            
            // For Stories format, ensure we have a default template selected
            if (selectedFormat === "new" && !localStorage.getItem("selectedTemplate")) {
                savedTemplate = "TechCon_Template.png";
                localStorage.setItem("selectedTemplate", savedTemplate);
                
                // Automatically trigger template selection to show it as active and load photos
                setTimeout(() => {
                    changeTemplate(savedTemplate);
                }, 50);
            } else if (selectedFormat === "old" && !localStorage.getItem("selectedTemplate")) {
                savedTemplate = "template1.png";
                localStorage.setItem("selectedTemplate", savedTemplate);
                
                // Automatically trigger template selection
                setTimeout(() => {
                    changeTemplate(savedTemplate);
                }, 50);
            }
            
            const templatePath = getTemplatePath(savedTemplate);
            document.getElementById("template-image").style.backgroundImage = `url('${templatePath}')`;
            
            // Ensure the correct template button is highlighted
            setTimeout(() => {
                document.querySelectorAll(".template-btn").forEach((btn) => btn.classList.remove("active-template"));
                document.querySelector(`.template-btn[data-template='${savedTemplate}']`)?.classList.add("active-template");
            }, 100);
        }
    
        // ‚úÖ Process & Upload Image
        async function downloadImage() {
            console.log("üéØ Download image function called");
            
            // Refresh token from localStorage first
            refreshAccessToken();
            
            // Check if user is signed in before processing
            if (!accessToken) {
                console.error("‚ùå No access token available");
                alert("Please sign in with Google first to upload your photo.");
                document.getElementById("settingsPanel").classList.add("show");
                return;
            }
            
            console.log("‚úÖ Access token found, proceeding with download");
            
            // Show progress dialog immediately
            showProgressDialog();
            updateProgress(0, "Preparing your photos...");
            
    const settings = getDownloadSettings();
    const canvas = document.createElement("canvas");
    canvas.width = settings.originalWidth;
    canvas.height = settings.originalHeight;
    const ctx = canvas.getContext("2d");

    const images = JSON.parse(localStorage.getItem("capturedPhotos")) || [];
    
    if (images.length !== 3) {
        hideProgressDialog();
        alert("Please capture 3 photos before downloading.");
        return;
    }
    
    let loadedImages = 0;
    images.forEach((src, index) => {
        const img = new Image();
        img.src = src;
        img.onload = () => {
            const imgAspect = img.width / img.height;
            const targetAspect = settings.photoWidth / settings.photoHeight;

            let sx, sy, sWidth, sHeight;

            if (imgAspect > targetAspect) {
                // Image is wider than target, crop sides
                sHeight = img.height;
                sWidth = sHeight * targetAspect;
                sx = (img.width - sWidth) / 2;
                sy = 0;
            } else {
                // Image is taller than target, crop top & bottom
                sWidth = img.width;
                sHeight = sWidth / targetAspect;
                sx = 0;
                sy = (img.height - sHeight) / 2;
            }

            // Draw cropped image
            ctx.drawImage(img, sx, sy, sWidth, sHeight, 
                settings.photoPositions[index].x, 
                settings.photoPositions[index].y, 
                settings.photoWidth, 
                settings.photoHeight);
            loadedImages++;
            updateProgress(Math.round((loadedImages / images.length) * 25), `Processing photo ${loadedImages} of ${images.length}...`);
            if (loadedImages === images.length) {
                updateProgress(30, "Applying template...");
                drawTemplate();
            }
        };
        
        img.onerror = () => {
            console.error("Failed to load image:", src);
            alert("Failed to load photos. Please try again.");
        };
    });

    function drawTemplate() {
        const settings = getDownloadSettings();
        const templateImg = new Image();
        templateImg.src = getTemplatePath(currentTemplate);
        templateImg.onload = () => {
            updateProgress(35, "Rendering final image...");
            ctx.drawImage(templateImg, 0, 0, settings.originalWidth, settings.originalHeight);

            // Convert canvas to Blob
            canvas.toBlob(async (blob) => {
                if (!blob) {
                    alert("Failed to generate image. Please try again.");
                    hideProgressDialog();
                    return;
                }
                
                updateProgress(40, "Preparing download...");
                const file = new File([blob], `photobooth-${Date.now()}.jpg`, { type: "image/jpeg" });

                // Save locally first
                let link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `photobooth-${Date.now()}.jpg`;
                link.click();

                // Upload to Google Drive immediately (no delay)
                updateProgress(45, "Starting upload...");
                await uploadToGoogleDrive(file);
            }, "image/jpeg", 0.85); // Optimized quality for smaller file size
        };
        
        templateImg.onerror = () => {
            console.error("Failed to load template:", getTemplatePath(currentTemplate));
            alert("Failed to load template. Please try again.");
        };
    }
}

function showProgressDialog() {
        const progressDialog = document.getElementById("progressDialog");
        const progressBar = document.getElementById("progressBar");
        
        if (progressDialog && progressBar) {
            document.body.classList.add("progress-loading");
            progressDialog.style.display = "flex";
            progressBar.style.width = "0%"; // Reset progress
            
            // Smooth show animation
            requestAnimationFrame(() => {
                progressDialog.classList.add("show");
            });
        } else {
            console.error("progressDialog not found!");
        }
    }

    function hideProgressDialog() {
        const progressDialog = document.getElementById("progressDialog");
        
        if (progressDialog) {
            document.body.classList.remove("progress-loading");
            progressDialog.classList.remove("show");
            
            // Hide after animation completes
            setTimeout(() => {
                progressDialog.style.display = "none";
            }, 400);
        }
    }

    // Validate Google OAuth token
    async function validateGoogleToken(token) {
        try {
            const response = await fetch(`https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=${token}`);
            if (response.ok) {
                const tokenInfo = await response.json();
                console.log("‚úÖ Token is valid:", tokenInfo);
                return true;
            } else {
                console.error("‚ùå Token validation failed:", response.status, response.statusText);
                return false;
            }
        } catch (error) {
            console.error("‚ùå Token validation error:", error);
            return false;
        }
    }

    function showProgressDialog() {
        const progressDialog = document.getElementById("progressDialog");
        const progressBar = document.getElementById("progressBar");
        
        if (progressDialog && progressBar) {
            document.body.classList.add("progress-loading");
            progressDialog.style.display = "flex";
            progressBar.style.width = "0%"; // Reset progress
            
            // Smooth show animation
            requestAnimationFrame(() => {
                progressDialog.classList.add("show");
            });
        }
    }

    function hideProgressDialog() {
        const progressDialog = document.getElementById("progressDialog");
        
        if (progressDialog) {
            document.body.classList.remove("progress-loading");
            progressDialog.classList.remove("show");
            
            // Hide after animation completes
            setTimeout(() => {
                progressDialog.style.display = "none";
            }, 400);
        }
    }

    // Update progress bar and text with smooth animations
    function updateProgress(percentage, message) {
        const progressBar = document.getElementById("progressBar");
        const progressMessage = document.querySelector(".progress-message");
        const progressPercentage = document.querySelector(".progress-percentage");
        
        if (progressBar) {
            progressBar.style.width = percentage + "%";
        }
        
        if (progressMessage) {
            progressMessage.style.opacity = "0";
            progressMessage.style.transform = "translateY(5px)";
            
            setTimeout(() => {
                progressMessage.textContent = message;
                progressMessage.style.opacity = "1";
                progressMessage.style.transform = "translateY(0)";
            }, 150);
        }
        
        if (progressPercentage) {
            progressPercentage.textContent = percentage + "%";
        }
        
        console.log(`üìä Progress: ${percentage}% - ${message}`);
    }

async function uploadToGoogleDrive(imageFile) {
    const folderId = "1neM9JyLAvjX3L28J8berY9WMUfO43kno";
    
    // Check if we have a valid token
    if (!accessToken) {
        hideProgressDialog();
        alert("Please sign in with Google first to upload your photo.");
        document.getElementById("settingsPanel").classList.remove("hidden");
        return;
    }
    
    // Validate token before attempting upload
    const isTokenValid = await validateGoogleToken(accessToken);
    if (!isTokenValid) {
        hideProgressDialog();
        accessToken = "";
        localStorage.removeItem("googleAccessToken");
        alert("Your Google session has expired. Please sign in again.");
        document.getElementById("settingsPanel").classList.remove("hidden");
        
        const signInOption = document.getElementById("signInOption");
        const logoutOption = document.getElementById("logoutOption");
        if (signInOption) {
            signInOption.style.display = "flex";
        }
        if (logoutOption) {
            logoutOption.style.display = "none";
        }
        document.getElementById("userInfo").innerText = "Session expired. Please sign in again.";
        return;
    }

    try {
        console.log("üì§ Uploading photobooth.png to Google Drive...");
        
        // Update progress: Starting upload
        updateProgress(50, "Initializing upload...");
        
        // Create file metadata and upload content simultaneously for better performance
        const fileName = `photobooth-${Date.now()}.png`;
        const metadata = {
            name: fileName,
            mimeType: "image/png",
            parents: [folderId]
        };

        // Update progress: Creating file
        updateProgress(55, "Creating file...");

        // Use resumable upload for better performance and reliability
        const createResponse = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable", {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${accessToken}`,
                "Content-Type": "application/json",
                "X-Upload-Content-Type": "image/png",
                "X-Upload-Content-Length": imageFile.size
            },
            body: JSON.stringify(metadata)
        });

        if (!createResponse.ok) {
            const errorText = await createResponse.text();
            console.error("‚ùå Create file error response:", errorText);
            throw new Error(`Failed to create file: ${createResponse.status} ${createResponse.statusText}`);
        }

        const uploadUrl = createResponse.headers.get('Location');
        
        // Update progress: Uploading content
        updateProgress(60, "Uploading image data...");

        // Start upload with progress simulation for small files
        const uploadPromise = fetch(uploadUrl, {
            method: "PUT",
            headers: {
                "Content-Type": "image/png"
            },
            body: imageFile
        });

        // Simulate upload progress for better UX
        let currentProgress = 60;
        const progressInterval = setInterval(() => {
            if (currentProgress < 72) {
                currentProgress += 2;
                updateProgress(currentProgress, "Uploading image data...");
            }
        }, 100);

        const uploadResponse = await uploadPromise;
        clearInterval(progressInterval);

        // Quick progress updates during upload
        updateProgress(75, "Processing upload...");

        if (!uploadResponse.ok) {
            throw new Error(`Failed to upload file: ${uploadResponse.status} ${uploadResponse.statusText}`);
        }

        const uploadResult = await uploadResponse.json();
        const fileId = uploadResult.id;
        console.log("‚úÖ Upload successful:", uploadResult);
        
        // Update progress: Making file public
        updateProgress(85, "Making file public...");
        
        // Make the file publicly accessible
        await makeFilePublic(fileId);
        
        // Update progress: Generating QR code
        updateProgress(95, "Generating QR code...");
        
        updateProgress(100, "Complete!");
        
        // Hide progress dialog and show QR modal smoothly
        setTimeout(() => {
            hideProgressDialog();
        }, 200);
        
    } catch (error) {
        console.error("‚ö† Error uploading to Google Drive:", error);
        hideProgressDialog();
        
        if (error.message.includes("401") || error.message.includes("403")) {
            // Token expired or invalid
            accessToken = "";
            localStorage.removeItem("googleAccessToken");
            alert("Your Google session has expired. Please sign in again and try uploading.");
            document.getElementById("settingsPanel").classList.remove("hidden");
            
            const signInOption = document.getElementById("signInOption");
            const logoutOption = document.getElementById("logoutOption");
            if (signInOption) {
                signInOption.style.display = "flex";
            }
            if (logoutOption) {
                logoutOption.style.display = "none";
            }
            document.getElementById("userInfo").innerText = "Session expired. Please sign in again.";
        } else if (error.message.includes("404")) {
            // API endpoint not found - try alternative method
            console.log("üîÑ Trying alternative upload method...");
            tryAlternativeUpload(imageFile, folderId);
        } else {
            alert(`Upload failed: ${error.message}. Please check your connection and try again.`);
        }
    }
}

// Alternative upload method using multipart upload
async function tryAlternativeUpload(imageFile, folderId) {
    try {
        console.log("üîÑ Attempting alternative multipart upload...");
        
        updateProgress(50, "Preparing alternative upload...");
        
        const metadata = {
            name: `photobooth-${Date.now()}.png`,
            mimeType: "image/png",
            parents: [folderId]
        };

        updateProgress(60, "Uploading with alternative method...");

        const formData = new FormData();
        formData.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
        formData.append("file", imageFile);

        const response = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${accessToken}`,
                "Accept": "application/json"
            },
            body: formData
        });

        if (response.ok) {
            const result = await response.json();
            console.log("‚úÖ Alternative upload successful:", result);
            
            updateProgress(85, "Making file public...");
            await makeFilePublic(result.id);
            
            updateProgress(95, "Generating QR code...");
            
            updateProgress(100, "Complete!");
            
            setTimeout(() => {
                hideProgressDialog();
            }, 200);
        } else {
            const errorText = await response.text();
            console.error("‚ùå Alternative upload failed:", response.status, errorText);
            hideProgressDialog();
            alert(`Upload failed with alternative method: ${response.status} ${response.statusText}. Please check your Google Drive API settings.`);
        }
    } catch (error) {
        console.error("‚ùå Alternative upload error:", error);
        hideProgressDialog();
        alert(`Alternative upload failed: ${error.message}. Please check your connection and Google Drive API configuration.`);
    }
}

// ‚úÖ Make uploaded file publicly accessible
async function makeFilePublic(fileId) {
    try {
        const permissionData = {
            role: "reader",
            type: "anyone"
        };

        const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}/permissions`, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${accessToken}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(permissionData)
        });

        if (response.ok) {
            console.log("‚úÖ File made publicly accessible");
            // Generate the public download URL
            const publicUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
            showQRModal(publicUrl);
        } else {
            console.error("‚ùå Failed to make file public:", response.statusText);
            // Still show QR with direct link even if permission setting failed
            showQRModal(`https://drive.google.com/file/d/${fileId}/view`);
        }
    } catch (error) {
        console.error("Error making file public:", error);
        // Fallback to direct Google Drive link
        showQRModal(`https://drive.google.com/file/d/${fileId}/view`);
    }
}


    function showQRModal(url) {
        // First hide the progress dialog smoothly
        const progressDialog = document.getElementById("progressDialog");
        if (progressDialog && progressDialog.classList.contains("show")) {
            document.body.classList.remove("progress-loading");
            progressDialog.classList.remove("show");
            
            // Wait for progress dialog to fade out completely before showing QR modal
            setTimeout(() => {
                progressDialog.style.display = "none";
                // Now show the QR modal
                showQRModalAfterDelay(url);
            }, 400); // Match the progress dialog transition duration
        } else {
            // No progress dialog to hide, show QR modal immediately
            showQRModalAfterDelay(url);
        }
    }
    
    function showQRModalAfterDelay(url) {
        const qrContainer = document.getElementById("qrCodeContainer");
        qrContainer.innerHTML = "";
        qrContainer.style.display = "flex"; // Show the container
        
        new QRCode(qrContainer, { 
            text: url, 
            width: 240, 
            height: 240,
            colorDark: "#1f2937",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
        });
        
        const modal = document.getElementById("qrModal");
        document.body.classList.add("modal-open");
        
        // Set display first but keep it hidden with opacity
        modal.style.display = "flex";
        modal.style.opacity = "0";
        
        // Smooth show animation with proper timing
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                modal.classList.add("show");
                modal.style.opacity = "";  // Remove inline opacity to let CSS handle it
            });
        });
    }

    function closeQRModal() {
        const modal = document.getElementById("qrModal");
        const qrContainer = document.getElementById("qrCodeContainer");
        
        document.body.classList.remove("modal-open");
        modal.classList.remove("show");
        
        // Wait for animation to complete before hiding
        setTimeout(() => {
            modal.style.display = "none";
            modal.style.opacity = "";  // Clear any inline opacity
            qrContainer.style.display = "none"; // Hide QR container
            qrContainer.innerHTML = ""; // Clear QR code
        }, 400); // Match the transition duration
        
        goBack();   
    }

    function goToFormatSelection() {
        const modal = document.getElementById("qrModal");
        const qrContainer = document.getElementById("qrCodeContainer");
        
        document.body.classList.remove("modal-open");
        modal.classList.remove("show");
        
        // Smooth transition out
        setTimeout(() => {
            modal.style.display = "none";
            qrContainer.style.display = "none"; // Hide QR container
            qrContainer.innerHTML = ""; // Clear QR code
            window.location.href = "format-selection.html";
        }, 300);
    }

    
        window.onload = function () {
            console.log("üöÄ Template page loaded, initializing...");
            
            // Apply format settings first (generates buttons)
            applyFormatSettings();
            
            // Load template and photos immediately without delays
            loadSelectedTemplate(); // This will auto-select default for Stories
            
            // Load photos immediately after template setup
            setTimeout(() => {
                loadPhotos();
                
                // Force immediate photo reload for Stories format
                const selectedFormat = localStorage.getItem("selectedFormat") || "new";
                if (selectedFormat === "new") {
                    // Ensure TechCon template is active and photos are loaded
                    changeTemplate("TechCon_Template.png");
                    
                    setTimeout(() => {
                        const firstStoriesBtn = document.getElementById("btn-stories1");
                        if (firstStoriesBtn) {
                            firstStoriesBtn.classList.add("active-template");
                        }
                    }, 100);
                }
            }, 50);
            
            // Check login status after DOM is ready
            setTimeout(() => {
                console.log("üîç Checking login status after DOM ready...");
                checkTemplateLoginStatus();
            }, 100);
            
            // Ensure logout button event listener is attached (fallback)
            setTimeout(() => {
                const logoutButton = document.getElementById("logoutButton");
                if (logoutButton && !logoutButton.hasAttribute('data-listener-attached')) {
                    console.log("üîÑ Attaching fallback logout button event listener");
                    logoutButton.setAttribute('data-listener-attached', 'true');
                    logoutButton.addEventListener("click", function (event) {
                        event.preventDefault();
                        console.log("üñ±Ô∏è Logout button clicked (fallback)");
                        logout();
                    });
                }
            }, 200);
            
            // Ensure Google Sign-In button event listener is attached (fallback)
            setTimeout(() => {
                const googleSignInButton = document.getElementById("googleSignIn");
                if (googleSignInButton && !googleSignInButton.hasAttribute('data-listener-attached')) {
                    console.log("üîÑ Attaching fallback Google Sign-In button event listener");
                    googleSignInButton.setAttribute('data-listener-attached', 'true');
                    googleSignInButton.addEventListener("click", function (event) {
                        event.preventDefault();
                        console.log("üñ±Ô∏è Google Sign-In button clicked (fallback)");
                        signInWithGoogle();
                    });
                }
            }, 200);
            
            // Hide progress dialog
            const progressDialog = document.getElementById("progressDialog");
            if (progressDialog) {
                progressDialog.style.display = "none";
            }
        };
    
        // Attach Google Sign-In button event listener
        const googleSignInButton = document.getElementById("googleSignIn");
        if (googleSignInButton) {
            console.log("‚úÖ Google Sign-In button found, attaching event listener");
            googleSignInButton.setAttribute('data-listener-attached', 'true');
            googleSignInButton.addEventListener("click", function(event) {
                event.preventDefault();
                console.log("üñ±Ô∏è Google Sign-In button clicked");
                signInWithGoogle();
            });
        } else {
            console.error("‚ùå Google Sign-In button not found!");
        }
        
        // Add a manual refresh function for debugging
        window.refreshLoginStatus = function() {
            console.log("üîÑ Manual login status refresh requested");
            checkLoginStatus();
        };
        
        // Add a function to check modal status for debugging
        window.checkModalStatus = function() {
            console.log("üîç Checking modal status...");
            console.log("üîç Access token:", accessToken ? accessToken.substring(0, 20) + "..." : "none");
            console.log("üîç Modal is hidden:", document.getElementById("settingsPanel").classList.contains("hidden"));
            updateModalLoginStatus();
        };

        // ‚úÖ Function to Reset and Go Back to Index Page
        function goBack() {
        window.location.href = "main.html" ;
        }

        // ‚úÖ Generate template buttons based on selected format
        function generateTemplateButtons() {
            const selectedFormat = localStorage.getItem("selectedFormat") || "new";
            const templateButtonsContainer = document.querySelector(".template-buttons");
            
            // Clear existing buttons
            templateButtonsContainer.innerHTML = "";
            
            if (selectedFormat === "old") {
                // Classic templates (template1.png to template7.png)
                const classicTemplates = [
                    { name: "template1.png", color: "white" },
                    { name: "template2.png", color: "black" },
                    { name: "template3.png", color: "#c8b6b3" },
                    { name: "template4.png", color: "#ff0000" },
                    { name: "template5.png", color: "#fbffd4" },
                    { name: "template6.png", color: "#4a90e2" },
                    { name: "template7.png", color: "rgb(80, 122, 229)" }
                ];
                
                classicTemplates.forEach((template, index) => {
                    const button = document.createElement("button");
                    button.className = "template-btn";
                    button.setAttribute("data-template", template.name);
                    button.onclick = () => {
                        changeTemplate(template.name);
                        // Force immediate photo load
                        setTimeout(() => loadPhotos(), 0);
                    };
                    button.id = `btn-template${index + 1}`;
                    button.style.background = template.color;
                    button.style.border = "3px solid #606460";
                    templateButtonsContainer.appendChild(button);
                });
            } else {
                // Stories & Social templates (only 2 actual templates)
                const storiesTemplates = [
                    { name: "TechCon_Template.png", color: "rgb(80, 122, 229)" },
                    { name: "template1_169.png", color: "#4a90e2" }
                ];
                
                storiesTemplates.forEach((template, index) => {
                    const button = document.createElement("button");
                    button.className = "template-btn";
                    button.setAttribute("data-template", template.name);
                    button.onclick = () => {
                        changeTemplate(template.name);
                        // Force immediate photo load
                        setTimeout(() => loadPhotos(), 0);
                    };
                    button.id = `btn-stories${index + 1}`;
                    button.style.background = template.color;
            
                    templateButtonsContainer.appendChild(button);
                });
            }
        }
        
        // ‚úÖ Dynamic Format Configuration
        function applyFormatSettings() {
            const selectedFormat = localStorage.getItem("selectedFormat") || "new";
            const templateContainer = document.getElementById("photo-booth");
            const photoSlots = document.querySelectorAll(".photo-slot");
            const templateImage = document.getElementById("template-image");
            
            // Generate appropriate template buttons
            generateTemplateButtons();
            
            if (selectedFormat === "old") {
                // Apply old format settings
                templateContainer.style.width = "230px";
                templateContainer.style.height = "690px";
                
                // Update photo slots for old format
                photoSlots.forEach((slot, index) => {
                    slot.style.width = "210px";
                    slot.style.height = "150px";
                });
                
                // Position slots for old format
                document.querySelector(".slot1").style.top = "65px";
                document.querySelector(".slot2").style.top = "220px";
                document.querySelector(".slot3").style.top = "375px";
                
                // Set old template image
                const defaultOldTemplate = "template1.png";
                templateImage.style.backgroundImage = `url('${getTemplatePath(defaultOldTemplate)}')`;
                currentTemplate = defaultOldTemplate;
                localStorage.setItem("selectedTemplate", defaultOldTemplate);
                
                // Update template button
                document.getElementById("btn-template7").onclick = () => changeTemplate(defaultOldTemplate);
                
            } else {
                // Apply new format settings (current default)
                templateContainer.style.width = "315px";
                templateContainer.style.height = "560px";
                
                // Update photo slots for new format
                photoSlots.forEach((slot, index) => {
                    slot.style.width = "263px";
                    slot.style.height = "150px";
                });
                
                // Position slots for new format
                document.querySelector(".slot1").style.top = "26px";
                document.querySelector(".slot2").style.top = "189px";
                document.querySelector(".slot3").style.top = "350px";
                
                // Set new template image
                const defaultNewTemplate = "TechCon_Template.png";
                templateImage.style.backgroundImage = `url('${getTemplatePath(defaultNewTemplate)}')`;
                currentTemplate = defaultNewTemplate;
                localStorage.setItem("selectedTemplate", defaultNewTemplate);
                
                // Force immediate photo loading for Stories format
                setTimeout(() => {
                    loadPhotos();
                }, 50);
                
                // Update template button
                document.getElementById("btn-template7").onclick = () => changeTemplate('TechCon_Template.png');
            }
        }

        // ‚úÖ Update Download Function to Handle Both Formats
        function getDownloadSettings() {
            const selectedFormat = localStorage.getItem("selectedFormat") || "new";
            
            if (selectedFormat === "old") {
                return {
                    originalWidth: 1940, // Reduced from 2284 (15% smaller)
                    originalHeight: 5490, // Reduced from 6458 (15% smaller)
                    photoWidth: 1700, // Reduced from 2000 (15% smaller)
                    photoHeight: 1275, // Reduced from 1500 (15% smaller)
                    photoPositions: [
                        { x: 120, y: 383, width: 1700, height: 1275 }, // Adjusted positions for old format
                        { x: 120, y: 1700, width: 1700, height: 1275 },
                        { x: 120, y: 3013, width: 1700, height: 1275 }
                    ]
                };
            } else {
                return {
                    originalWidth: 1339, // Reduced from 1575 (15% smaller)
                    originalHeight: 2380, // Reduced from 2800 (15% smaller)
                    photoWidth: 1118, // Reduced from 1315 (15% smaller)
                    photoHeight: 638, // Reduced from 750 (15% smaller)
                    photoPositions: [
                        { x: 111, y: 111, width: 1118, height: 638 }, // Slot1: top: 26px adjusted
                        { x: 111, y: 814, width: 1118, height: 638 }, // Slot2: top: 191px adjusted
                        { x: 111, y: 1499, width: 1118, height: 638 } // Slot3: top: 352px adjusted
                    ]
                };
            }
        }
    </script>
    
    
</body>
</html>