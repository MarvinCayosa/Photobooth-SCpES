<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script
        src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"
    ></script>
    <script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
        integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
        crossorigin="anonymous"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link id="theme-link" rel="stylesheet" href="style.css">
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="script.js" defer></script>
    <title>Photo Booth Template</title>
    <style>
        #backButton {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            color: #333;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 22px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        #backButton:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        #backButton:active {
            transform: translateY(0);
        }

        #themeButton {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            color: #333;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 22px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        #themeButton:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        #themeButton:active {
            transform: translateY(0);
        }

        .icon {
            width: 20px;
            height: 20px;
        }

        .container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding-left: 50px;
            width: 80%;
        }
        

        .template-selection {
            display: flex;
            height: 100%;
            flex-direction: column;
            align-items: flex-start; /* Align content to the left */
            gap: 30px;
            padding-left: 50px; /* Adds spacing from the template */
        }

        .template-selection h1 {
            margin-bottom: 10px;
            align-self: flex-start; /* Aligns header with the template */
        }

        .template-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            max-width: 350px; /* Limit width to fit 5 buttons per row */
        }

        .template-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            transform: scale(1);
             border: 4px solid #7878782f;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .template-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            border-color: #4a90e2;
            z-index: 10;
            position: relative;
        }

        .template-btn.active-template {
            border: 4px solid #6b7b87;
            transform: scale(1.05);
        }

        .template-btn.active-template:hover {
            transform: scale(1.15);
        
        }
        #btn-template1 { background: white; }
        #btn-template2 { background: black; }
        #btn-template3 { background: #c8b6b3; }
        #btn-template4 { background: #ff0000; }
        #btn-template5 { background: #fbffd4; }
        #btn-template7 { background:rgb(80, 122, 229); }

        .template-container {
            position: relative;
            width: 315px;
            height: 560px;
            overflow: hidden;
            background: transparent;
            filter: drop-shadow(5px 5px 15px rgba(0, 0, 0, 0.223)); /* Soft shadow */
            margin-bottom: 0; /* Space between template and buttons */
        }

        .button-container {
            display: flex;
            flex-direction: row; /* Arrange buttons in a row */
            justify-content: center; /* Center the buttons */
            gap: 10px; /* Add spacing between buttons */
            margin-top: 5px; /* Add some spacing from the template */
        }
        .photo-slot {
            position: absolute;
            width: 263px;
            height: 150px;
            left: 50%;
            transform: translateX(-50%);
            background-size: cover;
            background-position: center;
            cursor: grab;
        }
        .slot1 { top: 26px; }
        .slot2 { top: 189px; }
        .slot3 { top: 350px; }

        .template {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('TechCon_Template.png') no-repeat center/contain;
            pointer-events: none;
            z-index: 1;
          
        }

     

        .btn-download{
            padding: 10px 20px;
            border: none;
            background: #37ba20;
            color: white;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 40px;
            transition: all 0.3s ease;
        }
        .btn-download:hover{
            color: white;
            background: #2f9e17;
        }

        .btn-again{
            padding: 11px 20px;
            border: none;
            background: #606460;
            color: white;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 40px;
            transition: all 0.3s ease;
        }
        .btn-again:hover{
            color: white;
            background: #4d4d4d;
        }

        .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        justify-content: center;
        align-items: center;
    }

    .modal.show {
        display: flex;
    }

    body.modal-open {
        overflow: hidden;
    }

    body.modal-open > *:not(.modal) {
        filter: blur(3px);
        transition: filter 0.3s ease;
    }

    body:not(.modal-open) > * {
        filter: none;
        transition: filter 0.3s ease;
    }

    .modal-content {
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        max-width: 350px;
        width: 90%;
        box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
    }

    #qrCodeContainer {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 20px 0;
    }

    .close-btn {
        background: #e11f1f;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        width: 100%;
        margin-top: 15px;
        animation: blink 2s infinite;
    }

    @keyframes blink {
    0% {
        opacity: 1;
    }
    50% {
        opacity: 0;
    }
    100% {
        opacity: 1;
    }
    }



    .close-btn:hover {
        background: #0056b3;
    }

    .hidden {
        display: none;
    }

#settingsPanel {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    width: 600px;
    text-align: center;
}

    #settingsButton {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #545656;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
    }

    #closeSettings {
        margin-top: 10px;
        background: red;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
    }

    #progressDialog {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0px 4px 10px rgba(0,0,0,0.2);
    width: 300px;
    text-align: center;
    z-index: 1000;
}

#progressDialog p {
    margin-bottom: 10px;
}

#progressBarContainer {
    width: 100%;
    background: #ddd;
    border-radius: 5px;
    overflow: hidden;
}

#progressBar {
    width: 0%;
    height: 10px;
    background: linear-gradient(to right, #ff512f, #dd2476);
    border-radius: 5px;
    transition: width 0.3s ease-in-out;
}

    
    </style>
</head>
<body>
    <!-- Back Button -->
    <button id="backButton" onclick="goBack()">‚Üê</button>
    
    <!-- Theme Toggle Button -->
    <button id="themeButton" onclick="toggleTheme()">
        <svg class="icon icon-moon" fill="currentColor">
            <use xlink:href="icons.svg#icon-moon"></use>
        </svg>
    </button>
    
    <!-- ‚úÖ QR Code Modal -->
    <div id="qrModal" class="modal">
        <div class="modal-content">
            <h2>Scan to Download</h2>
            <div id="qrCodeContainer"></div>
            <button class="close-btn" onclick="closeQRModal()">ONE MORE</button>
        </div>
    </div>

    <button id="settingsButton">Setup</button>


    <div class="background-container">
        <img src="bg.png" class="bg" alt="Background Image">
        <div class="elipse"></div>
        <svg class="border bottom-left" fill="currentColor">
            <use xlink:href="icons.svg#wave-1"></use>
        </svg>
        <svg class="border upper-right" fill="currentColor">
            <use xlink:href="icons.svg#wave-2"></use>
        </svg>
    </div>

    <div class="container">
        <div>
            <div class="template-container" id="photo-booth">
                <div class="photo-slot slot1" id="photo1" draggable="true"></div>
                <div class="photo-slot slot2" id="photo2" draggable="true"></div>
                <div class="photo-slot slot3" id="photo3" draggable="true"></div>
                <div class="template" id="template-image"></div>
            </div>
    
       
        </div>
    
        <!-- Template Selection Buttons -->
        <div class="template-selection">
            <h1 class="temp-title">Make it Yours!</h1>
            <div class="template-buttons">
                <button class="template-btn" onclick="changeTemplate('TechCon_Template.png'); setTimeout(() => loadPhotos(), 0);" id="btn-template7"></button>
                <!-- <button class="template-btn" onclick="changeTemplate('template4.png'); setTimeout(() => loadPhotos(), 0);" id="btn-template4"></button>
                <button class="template-btn" onclick="changeTemplate('template2.png'); setTimeout(() => loadPhotos(), 0);" id="btn-template2"></button>
                <button class="template-btn" onclick="changeTemplate('template3.png'); setTimeout(() => loadPhotos(), 0);" id="btn-template3"></button>
                <button class="template-btn" onclick="changeTemplate('template4.png'); setTimeout(() => loadPhotos(), 0);" id="btn-template4"></button>
                <button class="template-btn" onclick="changeTemplate('template5.png'); setTimeout(() => loadPhotos(), 0);" id="btn-template5"></button> -->

            </div>
            <div class="button-container">
                <button class="btn btn-download" onclick="downloadImage()">Finish</button>
                <div id="qrCodeContainer" class="mt-3"></div>
                <!-- ‚úÖ Settings Panel (Hidden by Default) -->
                <div id="settingsPanel" class="hidden">
                    <h3>Google Account</h3>
                    <p id="userInfo"></p>
                    <button id="googleSignIn">Sign in with Google</button>
                    <button id="logoutButton">Logout</button>
                    <button id="closeSettings">Close</button>
                </div>

                <!-- Progress Dialog -->
                <div id="progressDialog">
                    <div class="progress-box">
                        <p>Preparing your Photo QR</p>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="progressBar"></div>
                        </div>
                    </div>
                </div>

                <!-- ‚úÖ QR Code Modal -->
                <div id="qrModal" class="modal">
                    <div class="modal-content">
                        <span class="close-btn" onclick="closeQRModal()">&times;</span>
                        <h2>Scan to Access Image</h2>
                        <div id="qrCodeContainer"></div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const themeLink = document.getElementById("theme-link");
            const savedTheme = localStorage.getItem("theme");
    
            if (savedTheme === "dark") {
                themeLink.setAttribute("href", "dark-style.css");
            } else {
                themeLink.setAttribute("href", "style.css");
            }

            const settingsButton = document.getElementById("settingsButton");
            const settingsPanel = document.getElementById("settingsPanel");
            const closeSettings = document.getElementById("closeSettings");
            const logoutButton = document.getElementById("logoutButton");

            // Open Settings Panel
            settingsButton.addEventListener("click", function () {
                settingsPanel.classList.remove("hidden");
            });

            // Close Settings Panel
            closeSettings.addEventListener("click", function () {
                settingsPanel.classList.add("hidden");
            });

            
            if (!localStorage.getItem("userLoggedIn")) {
                window.location.href = "index.html"; // Redirect to login page
            }


            // Logout Function
            function logout() {
                alert("Logging out...");
                localStorage.clear(); // Clear stored session data
                window.location.href = "index.html"; // Redirect to login page
            }

            // Manual Logout Button
            logoutButton.addEventListener("click", function () {
                logout();
            });

            // Auto Logout if Script Fails
            setTimeout(function () {
                if (document.readyState !== "complete") {
                    alert("System encountered an issue. Logging out...");
                    logout();
                }
            }, 5000); // Checks after 5 seconds
               

        
        
        }

                
            
            );
    </script>
    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        let accessToken = localStorage.getItem("googleAccessToken") || "";
        const selectedFormat = localStorage.getItem("selectedFormat") || "new";
        
        // Helper function to get correct template path
        function getTemplatePath(templateName) {
            if (selectedFormat === "old") {
                return `classic_templates/${templateName}`;
            } else {
                return `stories_template/${templateName}`;
            }
        }
        
        // Get default template based on format
        function getDefaultTemplate() {
            return selectedFormat === "old" ? "template1.png" : "TechCon_Template.png";
        }
        
        let currentTemplate = localStorage.getItem("selectedTemplate") || getDefaultTemplate();
    
        // ‚úÖ Show/Hide Settings Panel
        document.getElementById("settingsButton").addEventListener("click", function () {
            document.getElementById("settingsPanel").classList.toggle("hidden");
        });
    
        document.getElementById("closeSettings").addEventListener("click", function () {
            document.getElementById("settingsPanel").classList.add("hidden");
        });
    
        // ‚úÖ Google OAuth Login
        function signInWithGoogle() {
            const client = google.accounts.oauth2.initTokenClient({
                client_id: "654676077812-h48jkkjumjraq8u76so7544dui1heheb.apps.googleusercontent.com",
                scope: "https://www.googleapis.com/auth/drive.file",
                callback: (response) => {
                    if (response.access_token) {
                        accessToken = response.access_token;
                        localStorage.setItem("googleAccessToken", accessToken);
                        document.getElementById("userInfo").innerText = "‚úÖ Signed in!";
                        document.getElementById("googleSignIn").classList.add("hidden");
                        console.log("‚úÖ OAuth Token:", accessToken);
                    } else {
                        console.error("‚ùå Login failed!");
                    }
                },
            });
            client.requestAccessToken();
        }
    
        // ‚úÖ Hide sign-in button if already logged in
        function checkLoginStatus() {
            if (accessToken) {
                // Verify token is still valid
                verifyToken();
            } else {
                document.getElementById("userInfo").innerText = "Please sign in to upload to Google Drive";
                document.getElementById("googleSignIn").classList.remove("hidden");
            }
        }
        
        // ‚úÖ Verify if the current token is still valid
        async function verifyToken() {
            try {
                const response = await fetch(`https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=${accessToken}`);
                if (response.ok) {
                    document.getElementById("googleSignIn").classList.add("hidden");
                    document.getElementById("userInfo").innerText = "‚úÖ Signed in and ready to upload!";
                    console.log("üîÑ Token is valid.");
                } else {
                    // Token expired or invalid
                    console.log("‚ùå Token expired, clearing stored token");
                    accessToken = "";
                    localStorage.removeItem("googleAccessToken");
                    document.getElementById("userInfo").innerText = "Session expired. Please sign in again.";
                    document.getElementById("googleSignIn").classList.remove("hidden");
                }
            } catch (error) {
                console.error("Error verifying token:", error);
                accessToken = "";
                localStorage.removeItem("googleAccessToken");
                document.getElementById("userInfo").innerText = "Please sign in to upload to Google Drive";
                document.getElementById("googleSignIn").classList.remove("hidden");
            }
        }
    
        // ‚úÖ Load Photos (Fix: Ensure they appear correctly)
        function loadPhotos() {
            const images = JSON.parse(localStorage.getItem("capturedPhotos")) || [];
            console.log("Loading photos:", images); // Debug log
            
            if (images.length === 3) {
                // Wait for DOM to be ready, then load photos
                const attemptLoad = () => {
                    const photo1 = document.getElementById("photo1");
                    const photo2 = document.getElementById("photo2");
                    const photo3 = document.getElementById("photo3");
                    
                    console.log("Photo elements found:", photo1, photo2, photo3); // Debug log
                    
                    if (photo1 && photo2 && photo3) {
                        // Clear any existing background images first
                        photo1.style.backgroundImage = "";
                        photo2.style.backgroundImage = "";
                        photo3.style.backgroundImage = "";
                        
                        // Force a small delay to ensure clearing takes effect
                        setTimeout(() => {
                            photo1.style.backgroundImage = `url('${images[0]}')`;
                            photo2.style.backgroundImage = `url('${images[1]}')`;
                            photo3.style.backgroundImage = `url('${images[2]}')`;
                            
                            // Ensure proper background properties for photo display
                            [photo1, photo2, photo3].forEach(element => {
                                element.style.backgroundSize = "cover";
                                element.style.backgroundPosition = "center";
                                element.style.backgroundRepeat = "no-repeat";
                            });
                            
                            console.log("Photos loaded successfully"); // Debug log
                        }, 10);
                    } else {
                        console.error("Photo elements not found in DOM"); // Debug log
                        // Retry after a short delay if elements not found
                        setTimeout(attemptLoad, 50);
                    }
                };
                
                attemptLoad();
            } else {
                console.warn("Not enough photos found:", images.length); // Debug log
            }
        }
    
        // ‚úÖ Change Template
        function changeTemplate(templateSrc) {
            console.log("Template changed to:", templateSrc);
            currentTemplate = templateSrc;
            localStorage.setItem("selectedTemplate", templateSrc);
    
            const templatePath = getTemplatePath(templateSrc);
            document.getElementById("template-image").style.backgroundImage = `url('${templatePath}')`;
    
            // ‚úÖ Highlight selected template button
            document.querySelectorAll(".template-btn").forEach((btn) => btn.classList.remove("active-template"));
            document.querySelector(`.template-btn[data-template='${templateSrc}']`)?.classList.add("active-template");
            
            // Load photos immediately when template changes (no delay)
            loadPhotos();
            
            // Force a second load after a short delay to ensure photos appear
            setTimeout(() => {
                loadPhotos();
            }, 50);
        }
    
        // ‚úÖ Load saved template on page refresh
        function loadSelectedTemplate() {
            const selectedFormat = localStorage.getItem("selectedFormat") || "new";
            let savedTemplate = localStorage.getItem("selectedTemplate") || getDefaultTemplate();
            
            // For Stories format, ensure we have a default template selected
            if (selectedFormat === "new" && !localStorage.getItem("selectedTemplate")) {
                savedTemplate = "TechCon_Template.png";
                localStorage.setItem("selectedTemplate", savedTemplate);
                
                // Automatically trigger template selection to show it as active and load photos
                setTimeout(() => {
                    changeTemplate(savedTemplate);
                }, 50);
            } else if (selectedFormat === "old" && !localStorage.getItem("selectedTemplate")) {
                savedTemplate = "template1.png";
                localStorage.setItem("selectedTemplate", savedTemplate);
                
                // Automatically trigger template selection
                setTimeout(() => {
                    changeTemplate(savedTemplate);
                }, 50);
            }
            
            const templatePath = getTemplatePath(savedTemplate);
            document.getElementById("template-image").style.backgroundImage = `url('${templatePath}')`;
            
            // Ensure the correct template button is highlighted
            setTimeout(() => {
                document.querySelectorAll(".template-btn").forEach((btn) => btn.classList.remove("active-template"));
                document.querySelector(`.template-btn[data-template='${savedTemplate}']`)?.classList.add("active-template");
            }, 100);
        }
    
        // ‚úÖ Process & Upload Image
        function downloadImage() {
            // Check if user is signed in before processing
            if (!accessToken) {
                alert("Please sign in with Google first to upload your photo.");
                document.getElementById("settingsPanel").classList.remove("hidden");
                return;
            }
            
    const settings = getDownloadSettings();
    const canvas = document.createElement("canvas");
    canvas.width = settings.originalWidth;
    canvas.height = settings.originalHeight;
    const ctx = canvas.getContext("2d");

    const images = JSON.parse(localStorage.getItem("capturedPhotos")) || [];
    
    if (images.length !== 3) {
        alert("Please capture 3 photos before downloading.");
        return;
    }
    
    let loadedImages = 0;
    images.forEach((src, index) => {
        const img = new Image();
        img.src = src;
        img.onload = () => {
            const imgAspect = img.width / img.height;
            const targetAspect = settings.photoWidth / settings.photoHeight;

            let sx, sy, sWidth, sHeight;

            if (imgAspect > targetAspect) {
                // Image is wider than target, crop sides
                sHeight = img.height;
                sWidth = sHeight * targetAspect;
                sx = (img.width - sWidth) / 2;
                sy = 0;
            } else {
                // Image is taller than target, crop top & bottom
                sWidth = img.width;
                sHeight = sWidth / targetAspect;
                sx = 0;
                sy = (img.height - sHeight) / 2;
            }

            // Draw cropped image
            ctx.drawImage(img, sx, sy, sWidth, sHeight, 
                settings.photoPositions[index].x, 
                settings.photoPositions[index].y, 
                settings.photoWidth, 
                settings.photoHeight);
            loadedImages++;
            if (loadedImages === images.length) {
                drawTemplate();
            }
        };
        
        img.onerror = () => {
            console.error("Failed to load image:", src);
            alert("Failed to load photos. Please try again.");
        };
    });

    function drawTemplate() {
        const settings = getDownloadSettings();
        const templateImg = new Image();
        templateImg.src = getTemplatePath(currentTemplate);
        templateImg.onload = () => {
            ctx.drawImage(templateImg, 0, 0, settings.originalWidth, settings.originalHeight);

            // Convert canvas to Blob
            canvas.toBlob(async (blob) => {
                if (!blob) {
                    alert("Failed to generate image. Please try again.");
                    return;
                }
                
                const file = new File([blob], `photobooth-${Date.now()}.png`, { type: "image/png" });

                // Save locally first
                let link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `photobooth-${Date.now()}.png`;
                link.click();

                // Upload to Google Drive after local save
                setTimeout(async () => {
                    await uploadToGoogleDrive(file);
                }, 1000);
            }, "image/png", 0.95); // High quality
        };
        
        templateImg.onerror = () => {
            console.error("Failed to load template:", getTemplatePath(currentTemplate));
            alert("Failed to load template. Please try again.");
        };
    }
}

function showProgressDialog() {
        const dialog = document.getElementById("progressDialog");
        if (dialog) {
            dialog.style.display = "flex";
        } else {
            console.error("progressDialog not found!");
        }
    }

    function hideProgressDialog() {
        const dialog = document.getElementById("progressDialog");
        if (dialog) {
            dialog.style.display = "none";
        }
    }

    function showProgressDialog() {
    const progressDialog = document.getElementById("progressDialog");
    const progressBar = document.getElementById("progressBar");
    
    if (progressDialog && progressBar) {
        progressDialog.style.display = "block";
        progressBar.style.width = "0%"; // Reset progress
    }
}

async function uploadToGoogleDrive(imageFile) {
    const folderId = "1AlJMgXUysE6bIG9imjwoWpDIdV91kBQB";
    
    // Check if we have a valid token
    if (!accessToken) {
        hideProgressDialog();
        alert("Please sign in with Google first to upload your photo.");
        document.getElementById("settingsPanel").classList.remove("hidden");
        return;
    }
    
    showProgressDialog();

    const metadata = {
        name: `photobooth-${Date.now()}.png`,
        mimeType: "image/png",
        parents: [folderId]
    };

    const formData = new FormData();
    formData.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
    formData.append("file", imageFile);

    try {
        console.log("üì§ Uploading photobooth.png to Google Drive...");
        
        const xhr = new XMLHttpRequest();
        xhr.open("POST", "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", true);
        xhr.setRequestHeader("Authorization", `Bearer ${accessToken}`);
        xhr.setRequestHeader("Accept", "application/json");

        // **Track upload progress**
        xhr.upload.onprogress = function (event) {
            if (event.lengthComputable) {
                let percentComplete = (event.loaded / event.total) * 100;
                document.getElementById("progressBar").style.width = percentComplete + "%";
                console.log(`Upload progress: ${percentComplete.toFixed(1)}%`);
            }
        };

        xhr.onload = function () {
            if (xhr.status === 200) {
                const result = JSON.parse(xhr.responseText);
                console.log("‚úÖ Upload successful:", result);
                hideProgressDialog();
                
                // Make the file publicly accessible
                makeFilePublic(result.id);
                
            } else if (xhr.status === 401) {
                console.error("‚ùå Token expired or invalid:", xhr.responseText);
                hideProgressDialog();
                
                // Clear invalid token
                accessToken = "";
                localStorage.removeItem("googleAccessToken");
                
                alert("Your Google session has expired. Please sign in again and try uploading.");
                document.getElementById("settingsPanel").classList.remove("hidden");
                document.getElementById("googleSignIn").classList.remove("hidden");
                document.getElementById("userInfo").innerText = "Session expired. Please sign in again.";
                
            } else {
                console.error("‚ùå Upload failed:", xhr.status, xhr.responseText);
                hideProgressDialog();
                alert(`Upload failed (Error ${xhr.status}). Please check your connection and try again.`);
            }
        };

        xhr.onerror = function () {
            console.error("‚ö† Network error uploading to Google Drive.");
            hideProgressDialog();
            alert("Network error occurred. Please check your internet connection and try again.");
        };

        xhr.ontimeout = function () {
            console.error("‚ö† Upload timed out.");
            hideProgressDialog();
            alert("Upload timed out. Please try again.");
        };

        // Set timeout to 60 seconds
        xhr.timeout = 60000;
        
        xhr.send(formData);
        
    } catch (error) {
        console.error("‚ö† Error:", error);
        hideProgressDialog();
        alert("An unexpected error occurred. Please try again.");
    }
}

// ‚úÖ Make uploaded file publicly accessible
async function makeFilePublic(fileId) {
    try {
        const permissionData = {
            role: "reader",
            type: "anyone"
        };

        const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}/permissions`, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${accessToken}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(permissionData)
        });

        if (response.ok) {
            console.log("‚úÖ File made publicly accessible");
            // Generate the public download URL
            const publicUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
            showQRModal(publicUrl);
        } else {
            console.error("‚ùå Failed to make file public:", response.statusText);
            // Still show QR with direct link even if permission setting failed
            showQRModal(`https://drive.google.com/file/d/${fileId}/view`);
        }
    } catch (error) {
        console.error("Error making file public:", error);
        // Fallback to direct Google Drive link
        showQRModal(`https://drive.google.com/file/d/${fileId}/view`);
    }
}


    function showQRModal(url) {
        document.getElementById("qrCodeContainer").innerHTML = "";
        new QRCode(document.getElementById("qrCodeContainer"), { text: url, width: 250, height: 250 });
        
        const modal = document.getElementById("qrModal");
        document.body.classList.add("modal-open");
        modal.classList.add("show");
        modal.style.display = "flex";
    }

    function closeQRModal() {
        const modal = document.getElementById("qrModal");
        document.body.classList.remove("modal-open");
        modal.classList.remove("show");
        modal.style.display = "none";
        goBack();   
    }

    
        window.onload = function () {
            applyFormatSettings(); // Apply format settings first (generates buttons)
            checkLoginStatus();
            
            // Load template and photos immediately without delays
            loadSelectedTemplate(); // This will auto-select default for Stories
            
            // Load photos immediately after template setup
            setTimeout(() => {
                loadPhotos();
                
                // Force immediate photo reload for Stories format
                const selectedFormat = localStorage.getItem("selectedFormat") || "new";
                if (selectedFormat === "new") {
                    // Ensure TechCon template is active and photos are loaded
                    changeTemplate("TechCon_Template.png");
                    
                    setTimeout(() => {
                        const firstStoriesBtn = document.getElementById("btn-stories1");
                        if (firstStoriesBtn) {
                            firstStoriesBtn.classList.add("active-template");
                        }
                    }, 100);
                }
            }, 50);
            
            document.getElementById("progressDialog").style.display = "none";
        };
    
        document.getElementById("googleSignIn").addEventListener("click", signInWithGoogle);

        // ‚úÖ Function to Reset and Go Back to Index Page
        function goBack() {
        window.location.href = "main.html" ;
        }

        // ‚úÖ Generate template buttons based on selected format
        function generateTemplateButtons() {
            const selectedFormat = localStorage.getItem("selectedFormat") || "new";
            const templateButtonsContainer = document.querySelector(".template-buttons");
            
            // Clear existing buttons
            templateButtonsContainer.innerHTML = "";
            
            if (selectedFormat === "old") {
                // Classic templates (template1.png to template7.png)
                const classicTemplates = [
                    { name: "template1.png", color: "white" },
                    { name: "template2.png", color: "black" },
                    { name: "template3.png", color: "#c8b6b3" },
                    { name: "template4.png", color: "#ff0000" },
                    { name: "template5.png", color: "#fbffd4" },
                    { name: "template6.png", color: "#4a90e2" },
                    { name: "template7.png", color: "rgb(80, 122, 229)" }
                ];
                
                classicTemplates.forEach((template, index) => {
                    const button = document.createElement("button");
                    button.className = "template-btn";
                    button.setAttribute("data-template", template.name);
                    button.onclick = () => {
                        changeTemplate(template.name);
                        // Force immediate photo load
                        setTimeout(() => loadPhotos(), 0);
                    };
                    button.id = `btn-template${index + 1}`;
                    button.style.background = template.color;
                    button.style.border = "3px solid #606460";
                    templateButtonsContainer.appendChild(button);
                });
            } else {
                // Stories & Social templates (only 2 actual templates)
                const storiesTemplates = [
                    { name: "TechCon_Template.png", color: "rgb(80, 122, 229)" },
                    { name: "template1_169.png", color: "#4a90e2" }
                ];
                
                storiesTemplates.forEach((template, index) => {
                    const button = document.createElement("button");
                    button.className = "template-btn";
                    button.setAttribute("data-template", template.name);
                    button.onclick = () => {
                        changeTemplate(template.name);
                        // Force immediate photo load
                        setTimeout(() => loadPhotos(), 0);
                    };
                    button.id = `btn-stories${index + 1}`;
                    button.style.background = template.color;
            
                    templateButtonsContainer.appendChild(button);
                });
            }
        }
        
        // ‚úÖ Dynamic Format Configuration
        function applyFormatSettings() {
            const selectedFormat = localStorage.getItem("selectedFormat") || "new";
            const templateContainer = document.getElementById("photo-booth");
            const photoSlots = document.querySelectorAll(".photo-slot");
            const templateImage = document.getElementById("template-image");
            
            // Generate appropriate template buttons
            generateTemplateButtons();
            
            if (selectedFormat === "old") {
                // Apply old format settings
                templateContainer.style.width = "230px";
                templateContainer.style.height = "690px";
                
                // Update photo slots for old format
                photoSlots.forEach((slot, index) => {
                    slot.style.width = "210px";
                    slot.style.height = "150px";
                });
                
                // Position slots for old format
                document.querySelector(".slot1").style.top = "65px";
                document.querySelector(".slot2").style.top = "220px";
                document.querySelector(".slot3").style.top = "375px";
                
                // Set old template image
                const defaultOldTemplate = "template1.png";
                templateImage.style.backgroundImage = `url('${getTemplatePath(defaultOldTemplate)}')`;
                currentTemplate = defaultOldTemplate;
                localStorage.setItem("selectedTemplate", defaultOldTemplate);
                
                // Update template button
                document.getElementById("btn-template7").onclick = () => changeTemplate(defaultOldTemplate);
                
            } else {
                // Apply new format settings (current default)
                templateContainer.style.width = "315px";
                templateContainer.style.height = "560px";
                
                // Update photo slots for new format
                photoSlots.forEach((slot, index) => {
                    slot.style.width = "263px";
                    slot.style.height = "150px";
                });
                
                // Position slots for new format
                document.querySelector(".slot1").style.top = "26px";
                document.querySelector(".slot2").style.top = "189px";
                document.querySelector(".slot3").style.top = "350px";
                
                // Set new template image
                const defaultNewTemplate = "TechCon_Template.png";
                templateImage.style.backgroundImage = `url('${getTemplatePath(defaultNewTemplate)}')`;
                currentTemplate = defaultNewTemplate;
                localStorage.setItem("selectedTemplate", defaultNewTemplate);
                
                // Force immediate photo loading for Stories format
                setTimeout(() => {
                    loadPhotos();
                }, 50);
                
                // Update template button
                document.getElementById("btn-template7").onclick = () => changeTemplate('TechCon_Template.png');
            }
        }

        // ‚úÖ Update Download Function to Handle Both Formats
        function getDownloadSettings() {
            const selectedFormat = localStorage.getItem("selectedFormat") || "new";
            
            if (selectedFormat === "old") {
                return {
                    originalWidth: 2284,
                    originalHeight: 6458, 
                    photoWidth: 2000,
                    photoHeight: 1500,
                    photoPositions: [
                        { x: 142, y: 450, width: 2000, height: 1500 }, // Centered positions for old format
                        { x: 142, y: 2000, width: 2000, height: 1500 },
                        { x: 142, y: 3545, width: 2000, height: 1500 }
                    ]
                };
            } else {
                return {
                    originalWidth: 1575, // 315 * 5
                    originalHeight: 2800, // 560 * 5
                    photoWidth: 1315, // 263 * 5
                    photoHeight: 750, // 150 * 5
                    photoPositions: [
                        { x: 130, y: 130, width: 1315, height: 750 }, // 26 * 5
                        { x: 130, y: 945, width: 1315, height: 750 }, // 189 * 5
                        { x: 130, y: 1750, width: 1315, height: 750 } // 350 * 5
                    ]
                };
            }
        }
    </script>
    
    
</body>
</html>