<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script
        src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"
    ></script>
    <script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
        integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
        crossorigin="anonymous"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link id="theme-link" rel="stylesheet" href="style.css">
    <!-- Google API script removed as it's not needed for OAuth -->
    <!-- script.js functionality is included inline in this file -->
    <title>Photo Booth Template</title>
    <style>
        #backButton {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            color: #333;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 22px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        #backButton:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        #backButton:active {
            transform: translateY(0);
        }

        #themeButton {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            color: #333;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 22px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        #themeButton:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        #themeButton:active {
            transform: translateY(0);
        }

        .icon {
            width: 20px;
            height: 20px;
        }

        .container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding-left: 50px;
            width: 80%;
        }
        

        .template-selection {
            display: flex;
            height: 100%;
            flex-direction: column;
            align-items: flex-start; /* Align content to the left */
            gap: 30px;
            padding-left: 50px; /* Adds spacing from the template */
        }

        .template-selection h1 {
            margin-bottom: 10px;
            align-self: flex-start; /* Aligns header with the template */
        }

        .template-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            max-width: 350px; /* Limit width to fit 5 buttons per row */
        }

        .template-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            transform: scale(1);
             border: 4px solid #7878782f;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .template-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            border-color: #4a90e2;
            z-index: 10;
            position: relative;
        }

        .template-btn.active-template {
            border: 4px solid #6b7b87;
            transform: scale(1.05);
        }

        .template-btn.active-template:hover {
            transform: scale(1.15);
        
        }
        #btn-template1 { background: white; }
        #btn-template2 { background: black; }
        #btn-template3 { background: #c8b6b3; }
        #btn-template4 { background: #ff0000; }
        #btn-template5 { background: #fbffd4; }
        #btn-template7 { background:rgb(80, 122, 229); }

        .template-container {
            position: relative;
            width: 315px;
            height: 560px;
            overflow: hidden;
            background: transparent;
            filter: drop-shadow(5px 5px 15px rgba(0, 0, 0, 0.223)); /* Soft shadow */
            margin-bottom: 0; /* Space between template and buttons */
        }

        .button-container {
            display: flex;
            flex-direction: row; /* Arrange buttons in a row */
            justify-content: center; /* Center the buttons */
            gap: 10px; /* Add spacing between buttons */
            margin-top: 5px; /* Add some spacing from the template */
        }
        .photo-slot {
            position: absolute;
            width: 263px;
            height: 150px;
            left: 50%;
            transform: translateX(-50%);
            background-size: cover;
            background-position: center;
            cursor: grab;
        }
        .slot1 { top: 26px; }
        .slot2 { top: 189px; }
        .slot3 { top: 350px; }

        .template {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('TechCon_Template.png') no-repeat center/contain;
            pointer-events: none;
            z-index: 1;
          
        }

     

        .btn-download{
            padding: 10px 20px;
            border: none;
            background: #37ba20;
            color: white;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 40px;
            transition: all 0.3s ease;
        }
        .btn-download:hover{
            color: white;
            background: #2f9e17;
        }

        .btn-again{
            padding: 11px 20px;
            border: none;
            background: #606460;
            color: white;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 40px;
            transition: all 0.3s ease;
        }
        .btn-again:hover{
            color: white;
            background: #4d4d4d;
        }

        .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        justify-content: center;
        align-items: center;
    }

    .modal.show {
        display: flex;
    }

    body.modal-open {
        overflow: hidden;
    }

    body.modal-open > *:not(.modal) {
        filter: blur(3px);
        transition: filter 0.3s ease;
    }

    body:not(.modal-open) > * {
        filter: none;
        transition: filter 0.3s ease;
    }

    .modal-content {
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        max-width: 350px;
        width: 90%;
        box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
    }

    #qrCodeContainer {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 20px 0;
    }

    .close-btn {
        background: #e11f1f;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        width: 100%;
        margin-top: 15px;
        animation: blink 2s infinite;
    }

    @keyframes blink {
    0% {
        opacity: 1;
    }
    50% {
        opacity: 0;
    }
    100% {
        opacity: 1;
    }
    }



    .close-btn:hover {
        background: #0056b3;
    }

    .hidden {
        display: none;
    }

    /* Material 3 Modal Animations */

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.9);
        }
        to {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
    }

    .settings-button {
        animation: buttonFadeIn 0.2s cubic-bezier(0.2, 0, 0, 1);
    }

    @keyframes buttonFadeIn {
        from {
            opacity: 0;
            transform: translateY(8px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Ripple Effect */
    .settings-button {
        position: relative;
        overflow: hidden;
    }

    .settings-button::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: translate(-50%, -50%);
        transition: width 0.3s, height 0.3s;
    }

    .settings-button:active::after {
        width: 300px;
        height: 300px;
    }

#settingsPanel {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(8px);
    z-index: 2000;
    animation: fadeIn 0.3s ease;
}

#settingsPanel.show {
    display: flex;
    align-items: center;
    justify-content: center;
}

.settings-modal-content {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    padding: 0;
    box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
    width: 90%;
    max-width: 450px;
    animation: slideUp 0.3s ease;
    overflow: hidden;
}

.settings-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 25px 30px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    background: rgba(255, 255, 255, 0.1);
}

.settings-modal-header h2 {
    font-size: 24px;
    font-weight: 700;
    color: #333;
    margin: 0;
}

.settings-close {
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: #666;
    padding: 0;
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
}

.settings-close:hover {
    background: rgba(0, 0, 0, 0.1);
    color: #333;
    transform: rotate(90deg);
}

.settings-modal-body {
    padding: 30px;
    max-height: 60vh;
    overflow-y: auto;
}

.settings-section {
    margin-bottom: 35px;
}

.settings-section:last-child {
    margin-bottom: 0;
}

.settings-section h3 {
    font-size: 18px;
    font-weight: 600;
    color: #333;
    margin: 0 0 8px 0;
}

.settings-description {
    font-size: 14px;
    color: #666;
    margin: 0 0 20px 0;
}

.settings-option {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 0;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

.settings-option:last-child {
    border-bottom: none;
    padding-bottom: 0;
}

.settings-option-info {
    flex: 1;
}

.settings-label {
    font-size: 16px;
    font-weight: 500;
    color: #333;
    margin: 0 0 4px 0;
    display: block;
}

.settings-sublabel {
    font-size: 13px;
    color: #666;
    display: block;
    line-height: 1.4;
}

.settings-modal-footer {
    display: flex;
    gap: 15px;
    padding: 25px 30px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    background: rgba(255, 255, 255, 0.1);
}

.settings-btn {
    flex: 1;
    padding: 12px 20px;
    border: none;
    border-radius: 12px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.settings-btn-secondary {
    background: rgba(0, 0, 0, 0.1);
    color: #666;
}

.settings-btn-secondary:hover {
    background: rgba(0, 0, 0, 0.15);
    color: #333;
}

.settings-btn-primary {
    background: #37ba20;
    color: white;
}

.settings-btn-primary:hover {
    background: #2f9e17;
    transform: translateY(-1px);
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from { 
        opacity: 0;
        transform: translateY(20px);
    }
    to { 
        opacity: 1;
        transform: translateY(0);
    }
}

    #settingsButton {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #6750a4;
        color: white;
        border: none;
        padding: 12px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        box-shadow: 0px 1px 2px 0px rgba(0, 0, 0, 0.3), 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
        transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #settingsButton:hover {
        box-shadow: 0px 1px 2px 0px rgba(0, 0, 0, 0.3), 0px 2px 6px 2px rgba(0, 0, 0, 0.15);
        transform: translateY(-1px);
    }

    #settingsButton:active {
        transform: translateY(0);
    }

    /* Old account modal styles removed - now using Settings modal design */

    #progressDialog {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0px 4px 10px rgba(0,0,0,0.2);
    width: 300px;
    text-align: center;
    z-index: 1000;
}

#progressDialog p {
    margin-bottom: 10px;
}

#progressBarContainer {
    width: 100%;
    background: #ddd;
    border-radius: 5px;
    overflow: hidden;
}

#progressBar {
    width: 0%;
    height: 10px;
    background: linear-gradient(to right, #ff512f, #dd2476);
    border-radius: 5px;
    transition: width 0.3s ease-in-out;
}

    
    </style>
</head>
<body>
    <!-- Back Button -->
    <button id="backButton" onclick="goBack()">‚Üê</button>
    
    <!-- Theme Toggle Button -->
    <button id="themeButton" onclick="toggleTheme()">
        <svg class="icon icon-moon" fill="currentColor">
            <use xlink:href="icons.svg#icon-moon"></use>
        </svg>
    </button>
    
    <!-- ‚úÖ QR Code Modal -->
    <div id="qrModal" class="modal">
        <div class="modal-content">
            <h2>Scan to Download</h2>
            <div id="qrCodeContainer"></div>
            <button class="close-btn" onclick="closeQRModal()">ONE MORE</button>
        </div>
    </div>

    <button id="settingsButton">Account</button>


    <div class="background-container">
        <img src="bg.png" class="bg" alt="Background Image">
        <div class="elipse"></div>
        <svg class="border bottom-left" fill="currentColor">
            <use xlink:href="icons.svg#wave-1"></use>
        </svg>
        <svg class="border upper-right" fill="currentColor">
            <use xlink:href="icons.svg#wave-2"></use>
        </svg>
    </div>

    <div class="container">
        <div>
            <div class="template-container" id="photo-booth">
                <div class="photo-slot slot1" id="photo1" draggable="true"></div>
                <div class="photo-slot slot2" id="photo2" draggable="true"></div>
                <div class="photo-slot slot3" id="photo3" draggable="true"></div>
                <div class="template" id="template-image"></div>
            </div>
    
       
        </div>
    
        <!-- Template Selection Buttons -->
        <div class="template-selection">
            <h1 class="temp-title">Make it Yours!</h1>
            <div class="template-buttons">
                <button class="template-btn" onclick="changeTemplate('TechCon_Template.png'); setTimeout(() => loadPhotos(), 0);" id="btn-template7"></button>
                <!-- <button class="template-btn" onclick="changeTemplate('template4.png'); setTimeout(() => loadPhotos(), 0);" id="btn-template4"></button>
                <button class="template-btn" onclick="changeTemplate('template2.png'); setTimeout(() => loadPhotos(), 0);" id="btn-template2"></button>
                <button class="template-btn" onclick="changeTemplate('template3.png'); setTimeout(() => loadPhotos(), 0);" id="btn-template3"></button>
                <button class="template-btn" onclick="changeTemplate('template4.png'); setTimeout(() => loadPhotos(), 0);" id="btn-template4"></button>
                <button class="template-btn" onclick="changeTemplate('template5.png'); setTimeout(() => loadPhotos(), 0);" id="btn-template5"></button> -->

            </div>
            <div class="button-container">
                <button class="btn btn-download" onclick="downloadImage()">Finish</button>
                <div id="qrCodeContainer" class="mt-3"></div>
                <!-- ‚úÖ Account Modal (Hidden by Default) -->
                <div id="settingsPanel" class="settings-modal">
                    <div class="settings-modal-content">
                        <div class="settings-modal-header">
                            <h2>Account</h2>
                            <button class="settings-close" onclick="closeAccountModal()">&times;</button>
                        </div>
                        <div class="settings-modal-body">
                            <div class="settings-section">
                                <h3>Google Account</h3>
                                <p class="settings-description">Manage your Google account connection</p>
                                
                                <div class="settings-option">
                                    <div class="settings-option-info">
                                        <label class="settings-label" id="userInfo">Please sign in to upload to Google Drive</label>
                                        <span class="settings-sublabel">Connect your Google account to upload photos</span>
                                    </div>
                                </div>
                                
                                <div class="settings-option" id="signInOption">
                                    <div class="settings-option-info">
                                        <label class="settings-label">Sign in with Google</label>
                                        <span class="settings-sublabel">Connect your Google account</span>
                                    </div>
                                    <button id="googleSignIn" class="settings-btn settings-btn-primary">Sign In</button>
                                </div>
                                
                                <div class="settings-option" id="logoutOption" style="display: none;">
                                    <div class="settings-option-info">
                                        <label class="settings-label">Logout</label>
                                        <span class="settings-sublabel">Disconnect your Google account</span>
                                    </div>
                                    <button id="logoutButton" class="settings-btn settings-btn-secondary">Logout</button>
                                </div>
                            </div>
                        </div>
                        <div class="settings-modal-footer">
                            <button class="settings-btn settings-btn-secondary" onclick="closeAccountModal()">Cancel</button>
                            <button class="settings-btn settings-btn-primary" onclick="closeAccountModal()">Done</button>
                        </div>
                    </div>
                </div>

                <!-- Progress Dialog -->
                <div id="progressDialog">
                    <p>Preparing your Photo QR</p>
                    <div id="progressBarContainer">
                        <div id="progressBar"></div>
                    </div>
                </div>

                <!-- ‚úÖ QR Code Modal -->
                <div id="qrModal" class="modal">
                    <div class="modal-content">
                        <span class="close-btn" onclick="closeQRModal()">&times;</span>
                        <h2>Scan to Access Image</h2>
                        <div id="qrCodeContainer"></div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const themeLink = document.getElementById("theme-link");
            const savedTheme = localStorage.getItem("theme");
    
            if (savedTheme === "dark") {
                themeLink.setAttribute("href", "dark-style.css");
            } else {
                themeLink.setAttribute("href", "style.css");
            }

            const settingsButton = document.getElementById("settingsButton");
            const settingsPanel = document.getElementById("settingsPanel");
            const closeSettings = document.getElementById("closeSettings");

            // Open Settings Panel
            settingsButton.addEventListener("click", function () {
                settingsPanel.classList.remove("hidden");
            });

            // Close Settings Panel
            closeSettings.addEventListener("click", function () {
                settingsPanel.classList.add("hidden");
            });

            
            // Check if user is logged in first
            checkLoginStatus();
            
            // Also check template-specific login status for UI updates
            checkTemplateLoginStatus();


            // Manual Logout Button - Attach event listener
            const logoutButton = document.getElementById("logoutButton");
            if (logoutButton) {
                console.log("‚úÖ Logout button found, attaching event listener");
                logoutButton.setAttribute('data-listener-attached', 'true');
                logoutButton.addEventListener("click", function (event) {
                    event.preventDefault();
                    console.log("üñ±Ô∏è Logout button clicked");
                    logout();
                });
            } else {
                console.error("‚ùå Logout button not found!");
            }

            // Auto Logout if Script Fails
            setTimeout(function () {
                if (document.readyState !== "complete") {
                    alert("System encountered an issue. Logging out...");
                    logout();
                }
            }, 5000); // Checks after 5 seconds
               

        
        
        }

                
            
            );
    </script>
    
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="shared-login.js"></script>
    <script>
        let accessToken = localStorage.getItem("googleAccessToken") || "";
        const selectedFormat = localStorage.getItem("selectedFormat") || "new";
        
        // ‚úÖ Global Logout Function
        async function logout() {
            console.log("üö™ Logging out...");
            
            try {
                // Revoke the Google OAuth token if it exists
                if (accessToken && accessToken.length > 0) {
                    console.log("üîÑ Revoking Google OAuth token...");
                    await revokeGoogleToken(accessToken);
                }
            } catch (error) {
                console.error("‚ùå Error revoking token:", error);
                // Continue with logout even if token revocation fails
            }
            
            // Clear local storage
            accessToken = "";
            localStorage.removeItem("googleAccessToken");
            localStorage.removeItem("userLoggedIn");
            
            // Update modal status
            updateModalLoginStatus();
            
            alert("Logged out successfully!");
        }
        
        // ‚úÖ Revoke Google OAuth Token
        async function revokeGoogleToken(token) {
            try {
                const response = await fetch(`https://oauth2.googleapis.com/revoke?token=${token}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                });
                
                if (response.ok) {
                    console.log("‚úÖ Google OAuth token revoked successfully");
                } else {
                    console.error("‚ùå Failed to revoke token:", response.status, response.statusText);
                }
            } catch (error) {
                console.error("‚ùå Error revoking token:", error);
                throw error;
            }
        }
        
        // Function to refresh access token from localStorage
        function refreshAccessToken() {
            const newToken = localStorage.getItem("googleAccessToken") || "";
            if (newToken !== accessToken) {
                console.log("üîÑ Access token updated from localStorage");
                accessToken = newToken;
            }
            return accessToken;
        }
        
        // Update modal login status when modal is opened
        function updateModalLoginStatus() {
            console.log("üîç Updating modal login status...");
            
            // Refresh token from localStorage
            refreshAccessToken();
            
            const userInfo = document.getElementById("userInfo");
            const signInOption = document.getElementById("signInOption");
            const logoutOption = document.getElementById("logoutOption");
            
            if (accessToken && accessToken.length > 0) {
                console.log("üîç Token found in modal, user should be signed in");
                if (userInfo) {
                    userInfo.innerText = "‚úÖ Signed in and ready to upload!";
                }
                if (signInOption) {
                    signInOption.style.display = "none";
                }
                if (logoutOption) {
                    logoutOption.style.display = "flex";
                }
            } else {
                console.log("üîç No token found in modal, user needs to sign in");
                if (userInfo) {
                    userInfo.innerText = "Please sign in to upload to Google Drive";
                }
                if (signInOption) {
                    signInOption.style.display = "flex";
                }
                if (logoutOption) {
                    logoutOption.style.display = "none";
                }
            }
        }
        
        // Helper function to get correct template path
        function getTemplatePath(templateName) {
            if (selectedFormat === "old") {
                return `classic_templates/${templateName}`;
            } else {
                return `stories_template/${templateName}`;
            }
        }
        
        // Get default template based on format
        function getDefaultTemplate() {
            return selectedFormat === "old" ? "template1.png" : "TechCon_Template.png";
        }
        
        let currentTemplate = localStorage.getItem("selectedTemplate") || getDefaultTemplate();
    
        // ‚úÖ Show/Hide Account Modal
        document.getElementById("settingsButton").addEventListener("click", function () {
            const settingsPanel = document.getElementById("settingsPanel");
            settingsPanel.classList.add("show");
            document.body.style.overflow = 'hidden';
            
            console.log("üîç Account modal opened, checking login status...");
            updateModalLoginStatus();
        });
    
        function closeAccountModal() {
            const settingsPanel = document.getElementById("settingsPanel");
            settingsPanel.classList.remove("show");
            document.body.style.overflow = '';
        }

        // Close modal when clicking outside
        document.getElementById("settingsPanel").addEventListener("click", function(event) {
            if (event.target === this) {
                closeAccountModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const settingsPanel = document.getElementById("settingsPanel");
                if (settingsPanel.classList.contains('show')) {
                    closeAccountModal();
                }
            }
        });
    
        // ‚úÖ Google OAuth Login
        function signInWithGoogle() {
            const client = google.accounts.oauth2.initTokenClient({
                client_id: "1050323234175-b5apn028urg40cqvmavnefprcfbfbqp6.apps.googleusercontent.com",
                scope: "https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive",
                callback: (response) => {
                    if (response.access_token) {
                        accessToken = response.access_token;
                        localStorage.setItem("googleAccessToken", accessToken);
                        document.getElementById("userInfo").innerText = "‚úÖ Signed in!";
                        
                        const signInOption = document.getElementById("signInOption");
                        const logoutOption = document.getElementById("logoutOption");
                        if (signInOption) {
                            signInOption.style.display = "none";
                        }
                        if (logoutOption) {
                            logoutOption.style.display = "flex";
                        }
                        
                        console.log("‚úÖ OAuth Token:", accessToken);
                        
                        // Validate token immediately after login
                        validateGoogleToken(accessToken).then(isValid => {
                            if (isValid) {
                                console.log("‚úÖ Token validated successfully after login");
                                // Update modal status if it's open
                                updateModalLoginStatus();
                            } else {
                                console.error("‚ùå Token validation failed after login");
                            }
                        });
                    } else {
                        console.error("‚ùå Login failed!");
                    }
                },
            });
            client.requestAccessToken();
        }
    
        // ‚úÖ Hide sign-in button if already logged in
        function checkTemplateLoginStatus() {
            console.log("üîç Checking template-specific login status...");
            
            // Refresh token from localStorage first
            refreshAccessToken();
            
            console.log("üîç Access token exists:", !!accessToken);
            console.log("üîç Access token value:", accessToken ? accessToken.substring(0, 20) + "..." : "none");
            
            if (accessToken && accessToken.length > 0) {
                // Verify token is still valid
                console.log("üîç Token found, verifying...");
                verifyToken();
            } else {
                console.log("üîç No token found, showing sign-in button");
                // Make sure elements exist before trying to update them
                const userInfo = document.getElementById("userInfo");
                const signInOption = document.getElementById("signInOption");
                const logoutOption = document.getElementById("logoutOption");
                
                if (userInfo) {
                    userInfo.innerText = "Please sign in to upload to Google Drive";
                }
                if (signInOption) {
                    signInOption.style.display = "flex";
                }
                if (logoutOption) {
                    logoutOption.style.display = "none";
                }
            }
        }
        
        // ‚úÖ Verify if the current token is still valid
        async function verifyToken() {
            try {
                console.log("üîç Verifying token with Google...");
                const response = await fetch(`https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=${accessToken}`);
                console.log("üîç Token verification response status:", response.status);
                
                if (response.ok) {
                    const tokenInfo = await response.json();
                    console.log("‚úÖ Token is valid:", tokenInfo);
                    
                    const signInOption = document.getElementById("signInOption");
                    const logoutOption = document.getElementById("logoutOption");
                    const userInfo = document.getElementById("userInfo");
                    
                    if (signInOption) {
                        signInOption.style.display = "none";
                    }
                    if (logoutOption) {
                        logoutOption.style.display = "flex";
                    }
                    if (userInfo) {
                        userInfo.innerText = "‚úÖ Signed in and ready to upload!";
                    }
                } else {
                    // Token expired or invalid
                    console.log("‚ùå Token expired or invalid, clearing stored token");
                    accessToken = "";
                    localStorage.removeItem("googleAccessToken");
                    
                    const userInfo = document.getElementById("userInfo");
                    const signInOption = document.getElementById("signInOption");
                    const logoutOption = document.getElementById("logoutOption");
                    
                    if (userInfo) {
                        userInfo.innerText = "Session expired. Please sign in again.";
                    }
                    if (signInOption) {
                        signInOption.style.display = "flex";
                    }
                    if (logoutOption) {
                        logoutOption.style.display = "none";
                    }
                }
            } catch (error) {
                console.error("‚ùå Error verifying token:", error);
                accessToken = "";
                localStorage.removeItem("googleAccessToken");
                
                const userInfo = document.getElementById("userInfo");
                const signInOption = document.getElementById("signInOption");
                const logoutOption = document.getElementById("logoutOption");
                
                if (userInfo) {
                    userInfo.innerText = "Please sign in to upload to Google Drive";
                }
                if (signInOption) {
                    signInOption.style.display = "flex";
                }
                if (logoutOption) {
                    logoutOption.style.display = "none";
                }
            }
        }
    
        // ‚úÖ Load Photos (Fix: Ensure they appear correctly)
        function loadPhotos() {
            const images = JSON.parse(localStorage.getItem("capturedPhotos")) || [];
            console.log("Loading photos:", images); // Debug log
            
            if (images.length === 3) {
                // Wait for DOM to be ready, then load photos
                const attemptLoad = () => {
                    const photo1 = document.getElementById("photo1");
                    const photo2 = document.getElementById("photo2");
                    const photo3 = document.getElementById("photo3");
                    
                    console.log("Photo elements found:", photo1, photo2, photo3); // Debug log
                    
                    if (photo1 && photo2 && photo3) {
                        // Clear any existing background images first
                        photo1.style.backgroundImage = "";
                        photo2.style.backgroundImage = "";
                        photo3.style.backgroundImage = "";
                        
                        // Force a small delay to ensure clearing takes effect
                        setTimeout(() => {
                            photo1.style.backgroundImage = `url('${images[0]}')`;
                            photo2.style.backgroundImage = `url('${images[1]}')`;
                            photo3.style.backgroundImage = `url('${images[2]}')`;
                            
                            // Ensure proper background properties for photo display
                            [photo1, photo2, photo3].forEach(element => {
                                element.style.backgroundSize = "cover";
                                element.style.backgroundPosition = "center";
                                element.style.backgroundRepeat = "no-repeat";
                            });
                            
                            console.log("Photos loaded successfully"); // Debug log
                        }, 10);
                    } else {
                        console.error("Photo elements not found in DOM"); // Debug log
                        // Retry after a short delay if elements not found
                        setTimeout(attemptLoad, 50);
                    }
                };
                
                attemptLoad();
            } else {
                console.warn("Not enough photos found:", images.length); // Debug log
            }
        }
    
        // ‚úÖ Change Template
        function changeTemplate(templateSrc) {
            console.log("Template changed to:", templateSrc);
            currentTemplate = templateSrc;
            localStorage.setItem("selectedTemplate", templateSrc);
    
            const templatePath = getTemplatePath(templateSrc);
            document.getElementById("template-image").style.backgroundImage = `url('${templatePath}')`;
    
            // ‚úÖ Highlight selected template button
            document.querySelectorAll(".template-btn").forEach((btn) => btn.classList.remove("active-template"));
            document.querySelector(`.template-btn[data-template='${templateSrc}']`)?.classList.add("active-template");
            
            // Load photos immediately when template changes (no delay)
            loadPhotos();
            
            // Force a second load after a short delay to ensure photos appear
            setTimeout(() => {
                loadPhotos();
            }, 50);
        }
    
        // ‚úÖ Load saved template on page refresh
        function loadSelectedTemplate() {
            const selectedFormat = localStorage.getItem("selectedFormat") || "new";
            let savedTemplate = localStorage.getItem("selectedTemplate") || getDefaultTemplate();
            
            // For Stories format, ensure we have a default template selected
            if (selectedFormat === "new" && !localStorage.getItem("selectedTemplate")) {
                savedTemplate = "TechCon_Template.png";
                localStorage.setItem("selectedTemplate", savedTemplate);
                
                // Automatically trigger template selection to show it as active and load photos
                setTimeout(() => {
                    changeTemplate(savedTemplate);
                }, 50);
            } else if (selectedFormat === "old" && !localStorage.getItem("selectedTemplate")) {
                savedTemplate = "template1.png";
                localStorage.setItem("selectedTemplate", savedTemplate);
                
                // Automatically trigger template selection
                setTimeout(() => {
                    changeTemplate(savedTemplate);
                }, 50);
            }
            
            const templatePath = getTemplatePath(savedTemplate);
            document.getElementById("template-image").style.backgroundImage = `url('${templatePath}')`;
            
            // Ensure the correct template button is highlighted
            setTimeout(() => {
                document.querySelectorAll(".template-btn").forEach((btn) => btn.classList.remove("active-template"));
                document.querySelector(`.template-btn[data-template='${savedTemplate}']`)?.classList.add("active-template");
            }, 100);
        }
    
        // ‚úÖ Process & Upload Image
        function downloadImage() {
            // Check if user is signed in before processing
            if (!accessToken) {
                alert("Please sign in with Google first to upload your photo.");
                document.getElementById("settingsPanel").classList.remove("hidden");
                return;
            }
            
    const settings = getDownloadSettings();
    const canvas = document.createElement("canvas");
    canvas.width = settings.originalWidth;
    canvas.height = settings.originalHeight;
    const ctx = canvas.getContext("2d");

    const images = JSON.parse(localStorage.getItem("capturedPhotos")) || [];
    
    if (images.length !== 3) {
        alert("Please capture 3 photos before downloading.");
        return;
    }
    
    let loadedImages = 0;
    images.forEach((src, index) => {
        const img = new Image();
        img.src = src;
        img.onload = () => {
            const imgAspect = img.width / img.height;
            const targetAspect = settings.photoWidth / settings.photoHeight;

            let sx, sy, sWidth, sHeight;

            if (imgAspect > targetAspect) {
                // Image is wider than target, crop sides
                sHeight = img.height;
                sWidth = sHeight * targetAspect;
                sx = (img.width - sWidth) / 2;
                sy = 0;
            } else {
                // Image is taller than target, crop top & bottom
                sWidth = img.width;
                sHeight = sWidth / targetAspect;
                sx = 0;
                sy = (img.height - sHeight) / 2;
            }

            // Draw cropped image
            ctx.drawImage(img, sx, sy, sWidth, sHeight, 
                settings.photoPositions[index].x, 
                settings.photoPositions[index].y, 
                settings.photoWidth, 
                settings.photoHeight);
            loadedImages++;
            if (loadedImages === images.length) {
                drawTemplate();
            }
        };
        
        img.onerror = () => {
            console.error("Failed to load image:", src);
            alert("Failed to load photos. Please try again.");
        };
    });

    function drawTemplate() {
        const settings = getDownloadSettings();
        const templateImg = new Image();
        templateImg.src = getTemplatePath(currentTemplate);
        templateImg.onload = () => {
            ctx.drawImage(templateImg, 0, 0, settings.originalWidth, settings.originalHeight);

            // Convert canvas to Blob
            canvas.toBlob(async (blob) => {
                if (!blob) {
                    alert("Failed to generate image. Please try again.");
                    return;
                }
                
                const file = new File([blob], `photobooth-${Date.now()}.png`, { type: "image/png" });

                // Save locally first
                let link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `photobooth-${Date.now()}.png`;
                link.click();

                // Upload to Google Drive after local save
                setTimeout(async () => {
                    await uploadToGoogleDrive(file);
                }, 1000);
            }, "image/png", 0.95); // High quality
        };
        
        templateImg.onerror = () => {
            console.error("Failed to load template:", getTemplatePath(currentTemplate));
            alert("Failed to load template. Please try again.");
        };
    }
}

function showProgressDialog() {
        const dialog = document.getElementById("progressDialog");
        if (dialog) {
            dialog.style.display = "flex";
        } else {
            console.error("progressDialog not found!");
        }
    }

    function hideProgressDialog() {
        const dialog = document.getElementById("progressDialog");
        if (dialog) {
            dialog.style.display = "none";
        }
    }

    // Validate Google OAuth token
    async function validateGoogleToken(token) {
        try {
            const response = await fetch(`https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=${token}`);
            if (response.ok) {
                const tokenInfo = await response.json();
                console.log("‚úÖ Token is valid:", tokenInfo);
                return true;
            } else {
                console.error("‚ùå Token validation failed:", response.status, response.statusText);
                return false;
            }
        } catch (error) {
            console.error("‚ùå Token validation error:", error);
            return false;
        }
    }

    function showProgressDialog() {
    const progressDialog = document.getElementById("progressDialog");
    const progressBar = document.getElementById("progressBar");
    
    if (progressDialog && progressBar) {
        progressDialog.style.display = "block";
        progressBar.style.width = "0%"; // Reset progress
    }
}

    // Update progress bar and text
    function updateProgress(percentage, message) {
        const progressBar = document.getElementById("progressBar");
        const progressText = document.querySelector("#progressDialog p");
        
        if (progressBar) {
            progressBar.style.width = percentage + "%";
        }
        
        if (progressText) {
            progressText.textContent = message;
        }
        
        console.log(`üìä Progress: ${percentage}% - ${message}`);
    }

async function uploadToGoogleDrive(imageFile) {
    const folderId = "1neM9JyLAvjX3L28J8berY9WMUfO43kno";
    
    // Check if we have a valid token
    if (!accessToken) {
        hideProgressDialog();
        alert("Please sign in with Google first to upload your photo.");
        document.getElementById("settingsPanel").classList.remove("hidden");
        return;
    }
    
    // Validate token before attempting upload
    const isTokenValid = await validateGoogleToken(accessToken);
    if (!isTokenValid) {
        hideProgressDialog();
        accessToken = "";
        localStorage.removeItem("googleAccessToken");
        alert("Your Google session has expired. Please sign in again.");
        document.getElementById("settingsPanel").classList.remove("hidden");
        
        const signInOption = document.getElementById("signInOption");
        const logoutOption = document.getElementById("logoutOption");
        if (signInOption) {
            signInOption.style.display = "flex";
        }
        if (logoutOption) {
            logoutOption.style.display = "none";
        }
        document.getElementById("userInfo").innerText = "Session expired. Please sign in again.";
        return;
    }
    
    showProgressDialog();

    try {
        console.log("üì§ Uploading photobooth.png to Google Drive...");
        
        // Update progress: Starting upload
        updateProgress(10, "Preparing upload...");
        
        // First, create the file metadata
        const metadata = {
            name: `photobooth-${Date.now()}.png`,
            mimeType: "image/png",
            parents: [folderId]
        };

        // Update progress: Creating file
        updateProgress(20, "Creating file...");

        // Create the file using the Drive API
        console.log("üîç Creating file with metadata:", metadata);
        console.log("üîç Using access token:", accessToken.substring(0, 20) + "...");
        
        const createResponse = await fetch("https://www.googleapis.com/drive/v3/files", {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${accessToken}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(metadata)
        });

        console.log("üîç Create response status:", createResponse.status);
        console.log("üîç Create response headers:", createResponse.headers);
        
        if (!createResponse.ok) {
            const errorText = await createResponse.text();
            console.error("‚ùå Create file error response:", errorText);
            throw new Error(`Failed to create file: ${createResponse.status} ${createResponse.statusText} - ${errorText}`);
        }

        const fileData = await createResponse.json();
        const fileId = fileData.id;
        
        console.log("üìÅ File created with ID:", fileId);

        // Update progress: Uploading content
        updateProgress(50, "Uploading image...");

        // Now upload the file content
        const uploadResponse = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
            method: "PATCH",
            headers: {
                "Authorization": `Bearer ${accessToken}`,
                "Content-Type": "image/png"
            },
            body: imageFile
        });

        if (!uploadResponse.ok) {
            throw new Error(`Failed to upload file: ${uploadResponse.status} ${uploadResponse.statusText}`);
        }

        const uploadResult = await uploadResponse.json();
        console.log("‚úÖ Upload successful:", uploadResult);
        
        // Update progress: Making file public
        updateProgress(80, "Making file public...");
        
        // Make the file publicly accessible
        await makeFilePublic(fileId);
        
        // Update progress: Generating QR code
        updateProgress(90, "Generating QR code...");
        
        // Small delay to show the progress
        await new Promise(resolve => setTimeout(resolve, 500));
        
        updateProgress(100, "Complete!");
        
        // Hide progress dialog after a short delay
        setTimeout(() => {
            hideProgressDialog();
        }, 1000);
        
    } catch (error) {
        console.error("‚ö† Error uploading to Google Drive:", error);
        hideProgressDialog();
        
        if (error.message.includes("401") || error.message.includes("403")) {
            // Token expired or invalid
            accessToken = "";
            localStorage.removeItem("googleAccessToken");
            alert("Your Google session has expired. Please sign in again and try uploading.");
            document.getElementById("settingsPanel").classList.remove("hidden");
            
            const signInOption = document.getElementById("signInOption");
            const logoutOption = document.getElementById("logoutOption");
            if (signInOption) {
                signInOption.style.display = "flex";
            }
            if (logoutOption) {
                logoutOption.style.display = "none";
            }
            document.getElementById("userInfo").innerText = "Session expired. Please sign in again.";
        } else if (error.message.includes("404")) {
            // API endpoint not found - try alternative method
            console.log("üîÑ Trying alternative upload method...");
            tryAlternativeUpload(imageFile, folderId);
        } else {
            alert(`Upload failed: ${error.message}. Please check your connection and try again.`);
        }
    }
}

// Alternative upload method using multipart upload
async function tryAlternativeUpload(imageFile, folderId) {
    try {
        console.log("üîÑ Attempting alternative multipart upload...");
        showProgressDialog();
        
        updateProgress(10, "Preparing alternative upload...");
        
        const metadata = {
            name: `photobooth-${Date.now()}.png`,
            mimeType: "image/png",
            parents: [folderId]
        };

        updateProgress(30, "Uploading with alternative method...");

        const formData = new FormData();
        formData.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
        formData.append("file", imageFile);

        const response = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${accessToken}`,
                "Accept": "application/json"
            },
            body: formData
        });

        if (response.ok) {
            const result = await response.json();
            console.log("‚úÖ Alternative upload successful:", result);
            
            updateProgress(80, "Making file public...");
            await makeFilePublic(result.id);
            
            updateProgress(90, "Generating QR code...");
            await new Promise(resolve => setTimeout(resolve, 500));
            
            updateProgress(100, "Complete!");
            
            setTimeout(() => {
                hideProgressDialog();
            }, 1000);
        } else {
            const errorText = await response.text();
            console.error("‚ùå Alternative upload failed:", response.status, errorText);
            hideProgressDialog();
            alert(`Upload failed with alternative method: ${response.status} ${response.statusText}. Please check your Google Drive API settings.`);
        }
    } catch (error) {
        console.error("‚ùå Alternative upload error:", error);
        hideProgressDialog();
        alert(`Alternative upload failed: ${error.message}. Please check your connection and Google Drive API configuration.`);
    }
}

// ‚úÖ Make uploaded file publicly accessible
async function makeFilePublic(fileId) {
    try {
        const permissionData = {
            role: "reader",
            type: "anyone"
        };

        const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}/permissions`, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${accessToken}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(permissionData)
        });

        if (response.ok) {
            console.log("‚úÖ File made publicly accessible");
            // Generate the public download URL
            const publicUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
            showQRModal(publicUrl);
        } else {
            console.error("‚ùå Failed to make file public:", response.statusText);
            // Still show QR with direct link even if permission setting failed
            showQRModal(`https://drive.google.com/file/d/${fileId}/view`);
        }
    } catch (error) {
        console.error("Error making file public:", error);
        // Fallback to direct Google Drive link
        showQRModal(`https://drive.google.com/file/d/${fileId}/view`);
    }
}


    function showQRModal(url) {
        document.getElementById("qrCodeContainer").innerHTML = "";
        new QRCode(document.getElementById("qrCodeContainer"), { text: url, width: 250, height: 250 });
        
        const modal = document.getElementById("qrModal");
        document.body.classList.add("modal-open");
        modal.classList.add("show");
        modal.style.display = "flex";
    }

    function closeQRModal() {
        const modal = document.getElementById("qrModal");
        document.body.classList.remove("modal-open");
        modal.classList.remove("show");
        modal.style.display = "none";
        goBack();   
    }

    
        window.onload = function () {
            console.log("üöÄ Template page loaded, initializing...");
            
            // Apply format settings first (generates buttons)
            applyFormatSettings();
            
            // Load template and photos immediately without delays
            loadSelectedTemplate(); // This will auto-select default for Stories
            
            // Load photos immediately after template setup
            setTimeout(() => {
                loadPhotos();
                
                // Force immediate photo reload for Stories format
                const selectedFormat = localStorage.getItem("selectedFormat") || "new";
                if (selectedFormat === "new") {
                    // Ensure TechCon template is active and photos are loaded
                    changeTemplate("TechCon_Template.png");
                    
                    setTimeout(() => {
                        const firstStoriesBtn = document.getElementById("btn-stories1");
                        if (firstStoriesBtn) {
                            firstStoriesBtn.classList.add("active-template");
                        }
                    }, 100);
                }
            }, 50);
            
            // Check login status after DOM is ready
            setTimeout(() => {
                console.log("üîç Checking login status after DOM ready...");
                checkTemplateLoginStatus();
            }, 100);
            
            // Ensure logout button event listener is attached (fallback)
            setTimeout(() => {
                const logoutButton = document.getElementById("logoutButton");
                if (logoutButton && !logoutButton.hasAttribute('data-listener-attached')) {
                    console.log("üîÑ Attaching fallback logout button event listener");
                    logoutButton.setAttribute('data-listener-attached', 'true');
                    logoutButton.addEventListener("click", function (event) {
                        event.preventDefault();
                        console.log("üñ±Ô∏è Logout button clicked (fallback)");
                        logout();
                    });
                }
            }, 200);
            
            // Ensure Google Sign-In button event listener is attached (fallback)
            setTimeout(() => {
                const googleSignInButton = document.getElementById("googleSignIn");
                if (googleSignInButton && !googleSignInButton.hasAttribute('data-listener-attached')) {
                    console.log("üîÑ Attaching fallback Google Sign-In button event listener");
                    googleSignInButton.setAttribute('data-listener-attached', 'true');
                    googleSignInButton.addEventListener("click", function (event) {
                        event.preventDefault();
                        console.log("üñ±Ô∏è Google Sign-In button clicked (fallback)");
                        signInWithGoogle();
                    });
                }
            }, 200);
            
            // Hide progress dialog
            const progressDialog = document.getElementById("progressDialog");
            if (progressDialog) {
                progressDialog.style.display = "none";
            }
        };
    
        // Attach Google Sign-In button event listener
        const googleSignInButton = document.getElementById("googleSignIn");
        if (googleSignInButton) {
            console.log("‚úÖ Google Sign-In button found, attaching event listener");
            googleSignInButton.setAttribute('data-listener-attached', 'true');
            googleSignInButton.addEventListener("click", function(event) {
                event.preventDefault();
                console.log("üñ±Ô∏è Google Sign-In button clicked");
                signInWithGoogle();
            });
        } else {
            console.error("‚ùå Google Sign-In button not found!");
        }
        
        // Add a manual refresh function for debugging
        window.refreshLoginStatus = function() {
            console.log("üîÑ Manual login status refresh requested");
            checkLoginStatus();
        };
        
        // Add a function to check modal status for debugging
        window.checkModalStatus = function() {
            console.log("üîç Checking modal status...");
            console.log("üîç Access token:", accessToken ? accessToken.substring(0, 20) + "..." : "none");
            console.log("üîç Modal is hidden:", document.getElementById("settingsPanel").classList.contains("hidden"));
            updateModalLoginStatus();
        };

        // ‚úÖ Function to Reset and Go Back to Index Page
        function goBack() {
        window.location.href = "main.html" ;
        }

        // ‚úÖ Generate template buttons based on selected format
        function generateTemplateButtons() {
            const selectedFormat = localStorage.getItem("selectedFormat") || "new";
            const templateButtonsContainer = document.querySelector(".template-buttons");
            
            // Clear existing buttons
            templateButtonsContainer.innerHTML = "";
            
            if (selectedFormat === "old") {
                // Classic templates (template1.png to template7.png)
                const classicTemplates = [
                    { name: "template1.png", color: "white" },
                    { name: "template2.png", color: "black" },
                    { name: "template3.png", color: "#c8b6b3" },
                    { name: "template4.png", color: "#ff0000" },
                    { name: "template5.png", color: "#fbffd4" },
                    { name: "template6.png", color: "#4a90e2" },
                    { name: "template7.png", color: "rgb(80, 122, 229)" }
                ];
                
                classicTemplates.forEach((template, index) => {
                    const button = document.createElement("button");
                    button.className = "template-btn";
                    button.setAttribute("data-template", template.name);
                    button.onclick = () => {
                        changeTemplate(template.name);
                        // Force immediate photo load
                        setTimeout(() => loadPhotos(), 0);
                    };
                    button.id = `btn-template${index + 1}`;
                    button.style.background = template.color;
                    button.style.border = "3px solid #606460";
                    templateButtonsContainer.appendChild(button);
                });
            } else {
                // Stories & Social templates (only 2 actual templates)
                const storiesTemplates = [
                    { name: "TechCon_Template.png", color: "rgb(80, 122, 229)" },
                    { name: "template1_169.png", color: "#4a90e2" }
                ];
                
                storiesTemplates.forEach((template, index) => {
                    const button = document.createElement("button");
                    button.className = "template-btn";
                    button.setAttribute("data-template", template.name);
                    button.onclick = () => {
                        changeTemplate(template.name);
                        // Force immediate photo load
                        setTimeout(() => loadPhotos(), 0);
                    };
                    button.id = `btn-stories${index + 1}`;
                    button.style.background = template.color;
            
                    templateButtonsContainer.appendChild(button);
                });
            }
        }
        
        // ‚úÖ Dynamic Format Configuration
        function applyFormatSettings() {
            const selectedFormat = localStorage.getItem("selectedFormat") || "new";
            const templateContainer = document.getElementById("photo-booth");
            const photoSlots = document.querySelectorAll(".photo-slot");
            const templateImage = document.getElementById("template-image");
            
            // Generate appropriate template buttons
            generateTemplateButtons();
            
            if (selectedFormat === "old") {
                // Apply old format settings
                templateContainer.style.width = "230px";
                templateContainer.style.height = "690px";
                
                // Update photo slots for old format
                photoSlots.forEach((slot, index) => {
                    slot.style.width = "210px";
                    slot.style.height = "150px";
                });
                
                // Position slots for old format
                document.querySelector(".slot1").style.top = "65px";
                document.querySelector(".slot2").style.top = "220px";
                document.querySelector(".slot3").style.top = "375px";
                
                // Set old template image
                const defaultOldTemplate = "template1.png";
                templateImage.style.backgroundImage = `url('${getTemplatePath(defaultOldTemplate)}')`;
                currentTemplate = defaultOldTemplate;
                localStorage.setItem("selectedTemplate", defaultOldTemplate);
                
                // Update template button
                document.getElementById("btn-template7").onclick = () => changeTemplate(defaultOldTemplate);
                
            } else {
                // Apply new format settings (current default)
                templateContainer.style.width = "315px";
                templateContainer.style.height = "560px";
                
                // Update photo slots for new format
                photoSlots.forEach((slot, index) => {
                    slot.style.width = "263px";
                    slot.style.height = "150px";
                });
                
                // Position slots for new format
                document.querySelector(".slot1").style.top = "26px";
                document.querySelector(".slot2").style.top = "189px";
                document.querySelector(".slot3").style.top = "350px";
                
                // Set new template image
                const defaultNewTemplate = "TechCon_Template.png";
                templateImage.style.backgroundImage = `url('${getTemplatePath(defaultNewTemplate)}')`;
                currentTemplate = defaultNewTemplate;
                localStorage.setItem("selectedTemplate", defaultNewTemplate);
                
                // Force immediate photo loading for Stories format
                setTimeout(() => {
                    loadPhotos();
                }, 50);
                
                // Update template button
                document.getElementById("btn-template7").onclick = () => changeTemplate('TechCon_Template.png');
            }
        }

        // ‚úÖ Update Download Function to Handle Both Formats
        function getDownloadSettings() {
            const selectedFormat = localStorage.getItem("selectedFormat") || "new";
            
            if (selectedFormat === "old") {
                return {
                    originalWidth: 2284,
                    originalHeight: 6458, 
                    photoWidth: 2000,
                    photoHeight: 1500,
                    photoPositions: [
                        { x: 142, y: 450, width: 2000, height: 1500 }, // Centered positions for old format
                        { x: 142, y: 2000, width: 2000, height: 1500 },
                        { x: 142, y: 3545, width: 2000, height: 1500 }
                    ]
                };
            } else {
                return {
                    originalWidth: 1575, // 315 * 5
                    originalHeight: 2800, // 560 * 5
                    photoWidth: 1315, // 263 * 5
                    photoHeight: 750, // 150 * 5
                    photoPositions: [
                        { x: 130, y: 130, width: 1315, height: 750 }, // 26 * 5
                        { x: 130, y: 945, width: 1315, height: 750 }, // 189 * 5
                        { x: 130, y: 1750, width: 1315, height: 750 } // 350 * 5
                    ]
                };
            }
        }
    </script>
    
    
</body>
</html>